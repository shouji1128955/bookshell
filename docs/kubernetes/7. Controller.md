

# 控制器 CRD 介绍

学习demo地址: https://github.com/schwarzeni/kubebuilder-appservice

### 项目架构描述

```go
 +---------------------+               +-----------------------------+
 |                     |  (1) Create   |                             |
 |      User (kubectl)  +--------------->      Kubernetes API         |
 |                     |               |                             |
 +---------------------+               +-----------------------------+
                                                ^
                                                |
                                                | (2) Watch
                                                |
+----------------------+          +-------------+-------------------+
|                      |          |                                 |
|     Operator         +----------->     Operator Controller         |
|  Controller (Reconcile)          |                                 |
|                      |          |    (Reconcile AppService)        |
+----------------------+          +-------------+-------------------+
                                                |
                                                | (3) Create/Update
                                                |
                      +-----------------------+ |                +------------------+
                      |                       | |                |                  |
                      |   Kubernetes          | +---------------->  Deployment      |
                      |   Resources (Service, |                  |                  |
                      |   Deployment, etc.)   |                  +------------------+
                      +-----------------------+

```



### 项目结构组成描述

```bash
.
├── Dockerfile                   # Docker 文件，用于打包 Operator 镜像
├── Makefile                     # 构建和管理项目的 Makefile
├── PROJECT                      # kubebuilder 项目的定义文件
├── config/                      # 配置目录，存放 CRD、RBAC、Webhook 等配置
│   ├── crd/
│   │   ├── bases/
│   │   │   └── <group>_<version>_<resource>.yaml  # 生成的 CRD 定义
│   ├── default/
│   │   └── kustomization.yaml   # 默认的 kustomize 文件，用于生成 YAML 清单
│   ├── manager/
│   │   └── manager.yaml         # 管理器 Deployment 的 YAML 文件
│   ├── rbac/
│   │   └── role.yaml            # 生成的 RBAC 权限控制文件
│   ├── samples/
│   │   └── <group>_<version>_<resource>.yaml  # 示例 CRD 文件
├── go.mod                       # Go 依赖管理文件
├── go.sum                       # Go 依赖版本锁定文件
├── hack/                        # 辅助脚本
│   └── boilerplate.go.txt
├── api/                         # API 定义目录
│   ├── v1alpha1/                # 定义自定义资源的版本
│   │   ├── appservice_types.go  # AppService CRD 的结构定义
│   │   ├── groupversion_info.go # 注册 API 组和版本信息
│   │   └── zz_generated.deepcopy.go  # 自动生成的 deepcopy 函数
├── controllers/                 # 控制器逻辑目录
│   └── appservice_controller.go # 上面提供的 Reconcile 代码应该放在这里
└── main.go                      # 项目的入口文件

```



精简版本

```go
.
├── config/                        # 配置目录
│   ├── crd/                       # CRD 定义
│   │   └── bases/
│   │       └── batch.example.com_appservices.yaml  # CRD YAML 文件
│   ├── manager/                   # 管理器配置
│   │   └── manager.yaml           # 部署控制器的 YAML 文件
│   ├── rbac/                      # RBAC 配置
│   │   └── role.yaml              # 控制器需要的权限
├── api/                           # API 定义目录
│   └── v1alpha1/
│       ├── appservice_types.go    # 自定义资源的结构定义
│       └── groupversion_info.go   # API 组和版本的注册
├── controllers/                   # 控制器逻辑目录
│   └── appservice_controller.go   # AppService 控制器逻辑
├── go.mod                         # Go 依赖管理文件
├── go.sum                         # Go 依赖版本锁定文件
└── main.go                        # 项目的入口文件

```

### 目录简要说明：

- `config/`: 配置文件目录，包含 CRD 定义、RBAC 和控制器部署等相关 YAML 文件。
- `api/v1alpha1/`: API 定义目录，包括自定义资源的 `Spec` 和 `Status` 结构体，以及注册 API 组和版本的代码。
- `controllers/`: 控制器逻辑所在目录，`appservice_controller.go` 实现了 `Reconcile` 逻辑。
- `main.go`: 项目入口文件，启动控制器管理器。



### 主要文件示例

#### `api/v1alpha1/appservice_types.go` (简化版本)

这是定义 `AppService` 自定义资源的文件。

```go
package v1alpha1

import (
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
)

// AppServiceSpec defines the desired state of AppService
type AppServiceSpec struct {
	// 定义你的 AppService 的 Spec 字段
	Replicas int32 `json:"replicas"`
}

// AppServiceStatus defines the observed state of AppService
type AppServiceStatus struct {
	// 定义你的 AppService 的 Status 字段
	AvailableReplicas int32 `json:"availableReplicas"`
}

// +kubebuilder:object:root=true
// +kubebuilder:subresource:status

// AppService is the Schema for the appservices API
type AppService struct {
	metav1.TypeMeta   `json:",inline"`
	metav1.ObjectMeta `json:"metadata,omitempty"`

	Spec   AppServiceSpec   `json:"spec,omitempty"`
	Status AppServiceStatus `json:"status,omitempty"`
}

// +kubebuilder:object:root=true

// AppServiceList contains a list of AppService
type AppServiceList struct {
	metav1.TypeMeta `json:",inline"`
	metav1.ListMeta `json:"metadata,omitempty"`
	Items           []AppService `json:"items"`
}

func init() {
	SchemeBuilder.Register(&AppService{}, &AppServiceList{})
}
```

#### `controllers/appservice_controller.go`

这就是你给出的 `Reconcile` 函数的地方

```go
package controllers

import (
	"context"
	"encoding/json"
	"reflect"

	"k8s.io/apimachinery/pkg/api/errors"
	"k8s.io/apimachinery/pkg/types"
	appsv1 "k8s.io/api/apps/v1"
	corev1 "k8s.io/api/core/v1"
	"sigs.k8s.io/controller-runtime/pkg/client"
	"sigs.k8s.io/controller-runtime/pkg/reconcile"

	batchv1alpha1 "example.com/api/v1alpha1"
	ctrl "sigs.k8s.io/controller-runtime"
)

func (r *AppServiceReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) {
	instance := &batchv1alpha1.AppService{}
	if err := r.Client.Get(ctx, req.NamespacedName, instance); err != nil {
		if errors.IsNotFound(err) {
			return reconcile.Result{}, nil
		}
		return reconcile.Result{}, err
	}

	if instance.DeletionTimestamp != nil {
		return reconcile.Result{}, nil
	}

	deployment := &appsv1.Deployment{}
	if err := r.Client.Get(ctx, req.NamespacedName, deployment); err != nil {
		if !errors.IsNotFound(err) {
			return ctrl.Result{}, err
		}

		deployment = NewDeployment(instance)
		if err := r.Client.Create(ctx, deployment); err != nil {
			return ctrl.Result{}, err
		}

		svc := NewService(instance)
		if err := r.Client.Create(ctx, svc); err != nil {
			return ctrl.Result{}, err
		}
	} else {
		oldSpec := &batchv1alpha1.AppServiceSpec{}
		if err := json.Unmarshal([]byte(instance.Annotations["spec"]), oldSpec); err != nil {
			return ctrl.Result{}, err
		}
		if !reflect.DeepEqual(instance.Spec, *oldSpec) {
			newDeployment := NewDeployment(instance)
			currDeployment := &appsv1.Deployment{}
			if err := r.Client.Get(ctx, req.NamespacedName, currDeployment); err != nil {
				return ctrl.Result{}, err
			}
			currDeployment.Spec = newDeployment.Spec
			if err := r.Client.Update(ctx, currDeployment); err != nil {
				return ctrl.Result{}, err
			}

			newService := NewService(instance)
			currService := &corev1.Service{}
			if err := r.Client.Get(ctx, req.NamespacedName, currService); err != nil {
				return ctrl.Result{}, err
			}
			currIP := currService.Spec.ClusterIP
			currService.Spec = newService.Spec
			currService.Spec.ClusterIP = currIP
			if err := r.Client.Update(ctx, currService); err != nil {
				return ctrl.Result{}, err
			}
		}
	}

	data, _ := json.Marshal(instance.Spec)
	if instance.Annotations != nil {
		instance.Annotations["spec"] = string(data)
	} else {
		instance.Annotations = map[string]string{"spec": string(data)}
	}
	if err := r.Client.Update(ctx, instance); err != nil {
		return ctrl.Result{}, err
	}

	return ctrl.Result{}, nil
}
```



### 如何生成这些文件

你可以通过以下步骤使用 `kubebuilder` 工具生成这些文件：

**安装 `kubebuilder`**：

```shell
go install sigs.k8s.io/kubebuilder/cmd@latest
```

**创建项目**：

```shell
kubebuilder init --domain example.com --repo example.com/api
```

**创建 API 和控制器**：

```shell
kubebuilder create api --group batch --version v1alpha1 --kind AppService
```

**编辑生成的控制器文件和 API 文件**：根据你的逻辑，修改控制器文件并添加 `AppService` 资源的业务逻辑。