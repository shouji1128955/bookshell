### ServiceMonitor

#### 1、通过ServiceMoinitor监控服务

默认监控path在metrics

##### 1、创建测试demo

```yaml
kind: Service
apiVersion: v1
metadata:
  name: example-app
  labels:
    app: example-app
spec:
  selector:
    app: example-app
  ports:
  - name: web
    port: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: example-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: example-app
  template:
    metadata:
      labels:
        app: example-app
    spec:
      containers:
      - name: example-app
        image: nginx:alpine
        ports:
        - name: web
          containerPort: 80

```

##### 2、查看

```
[root@master monitor]# kubectl get ep -l app=example-app
NAME          ENDPOINTS           AGE
example-app   10.244.167.179:80   60m
```

##### 3、创建ServiceMonitor

```yaml
[root@master monitor]# cat   ServiceMonitor_test.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: monitor-example-app
  namespace: default
  labels:
    release: mypro  #Prometheus所选择的标签
spec:
  namespaceSelector: #监控的pod所在名称空间
    matchNames:
    - default
  selector:  #选择监控endpoint的标签
    matchLabels:
      app: example-app
  endpoints:
  - port: web #service中对应的端口名称
```

#### 2、tcp监控

##### 1、创建probe

```yaml
apiVersion: monitoring.coreos.com/v1
kind: Probe
metadata:
  name: tcp-pg-connection
  namespace: smart
spec:
  interval: 60s
  module: tcp_connect
  prober:
    url: blackbox-exporter.monitoring.svc.cluster.local:19115
  targets:
    staticConfig:
      labels:
        group: tcp_pg_connection
        area: aliyun
      static:
      - 172.19.49.37:5432
      - 172.19.35.4:30433
```

##### 2、创建rules

```yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: tcp-prob-rules
  namespace: monitoring
spec:
  groups:
  - name: tcp-prob.rules
    rules:
    - alert: tcp-pg-connection
      expr: probe_success{group="tcp_pg_connection",area="aliyun"} == 0
      for: 2m
      labels:
        severity: Critical
      annotations:
        summary: tcp_pg_connection {{ $labels.instance }}
        description: tcp_pg_connection {{ $labels.instance }} ,四层不可达，服务宕机!!!   
```

#### 3、http监控

1、创建端点

```yaml
apiVersion: monitoring.coreos.com/v1
kind: Probe
metadata:
  generation: 15
  name: http-web-monitoring
  namespace: smart
spec:
  interval: 60s
  module: http_2xx
  prober:
    url: blackbox-exporter.monitoring.svc.cluster.local:19115
  targets:
    staticConfig:
      static:
      - https://h5ss.cmd.com
      - https://bms-api.cmd.com
      - https://www.cmd.com
      - https://chdownloader.cmd.com
      - https://www.cmd.com/cmdapi/api/v1/project/test11
      labels:
        type: http-web
```

2、创建告警

```yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: http-web-alert
  namespace: monitoring
spec:
  groups:
  - name: http-web.rules
    rules:
    - alert: http-web-code
      expr: probe_http_status_code{type="http-web"} !=200 
      for: 2m
      labels:
        severity: Critical
      annotations:
        description: http {{ $labels.instance }} ,网站不能正常访问!!!
```

