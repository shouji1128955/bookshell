"use strict";(self.webpackChunkbookshell=self.webpackChunkbookshell||[]).push([[2113],{5680:(e,a,t)=>{t.d(a,{xA:()=>d,yg:()=>h});var n=t(6540);function s(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function l(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function r(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?l(Object(t),!0).forEach((function(a){s(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function o(e,a){if(null==e)return{};var t,n,s=function(e,a){if(null==e)return{};var t,n,s={},l=Object.keys(e);for(n=0;n<l.length;n++)t=l[n],a.indexOf(t)>=0||(s[t]=e[t]);return s}(e,a);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)t=l[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(s[t]=e[t])}return s}var i=n.createContext({}),c=function(e){var a=n.useContext(i),t=a;return e&&(t="function"==typeof e?e(a):r(r({},a),e)),t},d=function(e){var a=c(e.components);return n.createElement(i.Provider,{value:a},e.children)},p="mdxType",u={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},m=n.forwardRef((function(e,a){var t=e.components,s=e.mdxType,l=e.originalType,i=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),p=c(t),m=s,h=p["".concat(i,".").concat(m)]||p[m]||u[m]||l;return t?n.createElement(h,r(r({ref:a},d),{},{components:t})):n.createElement(h,r({ref:a},d))}));function h(e,a){var t=arguments,s=a&&a.mdxType;if("string"==typeof e||s){var l=t.length,r=new Array(l);r[0]=m;var o={};for(var i in a)hasOwnProperty.call(a,i)&&(o[i]=a[i]);o.originalType=e,o[p]="string"==typeof e?e:s,r[1]=o;for(var c=2;c<l;c++)r[c]=t[c];return n.createElement.apply(null,r)}return n.createElement.apply(null,t)}m.displayName="MDXCreateElement"},5378:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>i,contentTitle:()=>r,default:()=>u,frontMatter:()=>l,metadata:()=>o,toc:()=>c});var n=t(8168),s=(t(6540),t(5680));const l={},r=void 0,o={unversionedId:"Sre/\u4e2d\u95f4\u4ef6/clickhouse",id:"Sre/\u4e2d\u95f4\u4ef6/clickhouse",title:"clickhouse",description:"Clickhouse\u96c6\u7fa4\u90e8\u7f72",source:"@site/docs/Sre/2-\u4e2d\u95f4\u4ef6/12.clickhouse.md",sourceDirName:"Sre/2-\u4e2d\u95f4\u4ef6",slug:"/Sre/\u4e2d\u95f4\u4ef6/clickhouse",permalink:"/bookshell/docs/Sre/\u4e2d\u95f4\u4ef6/clickhouse",draft:!1,editUrl:"https://github.com/shouji1128955/bookshell/edit/main/docs/Sre/2-\u4e2d\u95f4\u4ef6/12.clickhouse.md",tags:[],version:"current",lastUpdatedBy:"zhanglaiqiang",lastUpdatedAt:1727765685,formattedLastUpdatedAt:"2024\u5e7410\u67081\u65e5",sidebarPosition:12,frontMatter:{},sidebar:"SreMiddleSoft",previous:{title:"nginx",permalink:"/bookshell/docs/Sre/\u4e2d\u95f4\u4ef6/nginx"},next:{title:"nomad",permalink:"/bookshell/docs/Sre/\u4e2d\u95f4\u4ef6/nomad"}},i={},c=[{value:"Clickhouse\u96c6\u7fa4\u90e8\u7f72",id:"clickhouse\u96c6\u7fa4\u90e8\u7f72",level:2},{value:"DBA\u65e5\u5e38\u64cd\u4f5c",id:"dba\u65e5\u5e38\u64cd\u4f5c",level:2},{value:"\u5e38\u7528\u67e5\u8be2\u547d\u4ee4",id:"\u5e38\u7528\u67e5\u8be2\u547d\u4ee4",level:3},{value:"\u67e5\u770b\u6bcf\u4e2a\u5e93\u7684\u5927\u5c0f-\u6309\u7167\u5b9e\u9645\u5b57\u8282\u5c55\u793a",id:"\u67e5\u770b\u6bcf\u4e2a\u5e93\u7684\u5927\u5c0f-\u6309\u7167\u5b9e\u9645\u5b57\u8282\u5c55\u793a",level:3},{value:"\u67e5\u770b\u6bcf\u4e2a\u5e93\u7684\u5927\u5c0f-\u6309\u7167TiB\u5355\u4f4d\u5c55\u793a",id:"\u67e5\u770b\u6bcf\u4e2a\u5e93\u7684\u5927\u5c0f-\u6309\u7167tib\u5355\u4f4d\u5c55\u793a",level:3},{value:"clickhouse\u6dfb\u52a0\u5bc6\u7801",id:"clickhouse\u6dfb\u52a0\u5bc6\u7801",level:3},{value:"\u67e5\u770b\u5355\u4e2a\u5e93\u7684\u603b\u5927\u5c0f",id:"\u67e5\u770b\u5355\u4e2a\u5e93\u7684\u603b\u5927\u5c0f",level:3},{value:"\u67e5\u770b\u591a\u4e2a\u5e93\u7684\u5927\u5c0f",id:"\u67e5\u770b\u591a\u4e2a\u5e93\u7684\u5927\u5c0f",level:3},{value:"\u67e5\u770b\u5f53\u524d\u6570\u636e\u5e93\u6267\u884c\u7684\u8bed\u53e5",id:"\u67e5\u770b\u5f53\u524d\u6570\u636e\u5e93\u6267\u884c\u7684\u8bed\u53e5",level:3},{value:"\u67e5\u8be2\u5355\u4e2a\u5e93\u8868\u5927\u5c0f",id:"\u67e5\u8be2\u5355\u4e2a\u5e93\u8868\u5927\u5c0f",level:3},{value:"\u67e5\u8be2\u591a\u4e2a\u5e93\u7684\u5927\u5c0f",id:"\u67e5\u8be2\u591a\u4e2a\u5e93\u7684\u5927\u5c0f",level:3},{value:"\u67e5\u770b\u4e00\u4e2a\u5e93\u4e2d\u6240\u6709\u7684\u8868\u5927\u5c0f",id:"\u67e5\u770b\u4e00\u4e2a\u5e93\u4e2d\u6240\u6709\u7684\u8868\u5927\u5c0f",level:3},{value:"\u67e5\u8be2\u6bcf\u4e2a\u5206\u533a\u4ee5\u53ca\u5b50\u8def\u52b2\u5360\u7528\u7a7a\u95f4",id:"\u67e5\u8be2\u6bcf\u4e2a\u5206\u533a\u4ee5\u53ca\u5b50\u8def\u52b2\u5360\u7528\u7a7a\u95f4",level:3},{value:"\u67e5\u770b\u6307\u5b9a\u5e93\u6bcf\u4e2a\u6708\u6bcf\u4e2a\u6708\u6240\u5360\u78c1\u76d8\u7684\u7a7a\u95f4",id:"\u67e5\u770b\u6307\u5b9a\u5e93\u6bcf\u4e2a\u6708\u6bcf\u4e2a\u6708\u6240\u5360\u78c1\u76d8\u7684\u7a7a\u95f4",level:3},{value:"\u67e5\u8be2\u6bcf\u4e2a\u5206\u533a(\u6bcf\u4e2a\u6708) \u8868\u6240\u5360\u78c1\u76d8\u7a7a\u95f4\u7684\u603b\u548c \u5355\u4f4dGB",id:"\u67e5\u8be2\u6bcf\u4e2a\u5206\u533a\u6bcf\u4e2a\u6708-\u8868\u6240\u5360\u78c1\u76d8\u7a7a\u95f4\u7684\u603b\u548c-\u5355\u4f4dgb",level:3},{value:"\u67e5\u8be2\u6bcf\u6240\u6709\u5e93\u6bcf\u4e2a\u6708\u6240\u5360\u7684\u6570\u636e\u91cf",id:"\u67e5\u8be2\u6bcf\u6240\u6709\u5e93\u6bcf\u4e2a\u6708\u6240\u5360\u7684\u6570\u636e\u91cf",level:3},{value:"\u67e5\u770bclickhous\u5b9e\u4f8b\u6240\u5360\u78c1\u76d8\u603b\u7a7a\u95f4",id:"\u67e5\u770bclickhous\u5b9e\u4f8b\u6240\u5360\u78c1\u76d8\u603b\u7a7a\u95f4",level:3},{value:"\u67e5\u770b\u5206\u533a\u6240\u5728\u7684\u78c1\u76d8",id:"\u67e5\u770b\u5206\u533a\u6240\u5728\u7684\u78c1\u76d8",level:3},{value:"\u79fb\u52a8\u5206\u533a\u5230\u6307\u5b9a\u78c1\u76d8",id:"\u79fb\u52a8\u5206\u533a\u5230\u6307\u5b9a\u78c1\u76d8",level:3},{value:"\u6587\u4ef6\u5bfc\u51fa\u5bfc\u5165",id:"\u6587\u4ef6\u5bfc\u51fa\u5bfc\u5165",level:3},{value:"clickhouse\u5f02\u6b65\u5904\u7406\u8bb0\u5f55",id:"clickhouse\u5f02\u6b65\u5904\u7406\u8bb0\u5f55",level:3},{value:"\u67e5\u770b\u78c1\u76d8",id:"\u67e5\u770b\u78c1\u76d8",level:3},{value:"\u67e5\u770b\u5b58\u50a8\u7b56\u7565",id:"\u67e5\u770b\u5b58\u50a8\u7b56\u7565",level:3},{value:"\u521b\u5efa\u6570\u636e\u5e93",id:"\u521b\u5efa\u6570\u636e\u5e93",level:4},{value:"\u67e5\u770breceive_timeout",id:"\u67e5\u770breceive_timeout",level:3},{value:"clickhouse\u51b7\u70ed\u5206\u79bb",id:"clickhouse\u51b7\u70ed\u5206\u79bb",level:3},{value:"apk\u4fee\u6539\u6e90",id:"apk\u4fee\u6539\u6e90",level:3},{value:"clickhouse\u5907\u4efd\u548c\u8fd8\u539f",id:"clickhouse\u5907\u4efd\u548c\u8fd8\u539f",level:2},{value:"1\u3001Remote",id:"1remote",level:3},{value:"2\u3001clickhouse copier -\u624b\u52a8\u65b9\u5f0f",id:"2clickhouse-copier--\u624b\u52a8\u65b9\u5f0f",level:3},{value:"3\u3001clickhouse copier \u811a\u672c",id:"3clickhouse-copier-\u811a\u672c",level:3},{value:"4\u3001\u5728zookeeper\u9a8c\u8bc1\u540c\u6b65\u662f\u5426\u4e00\u81f4",id:"4\u5728zookeeper\u9a8c\u8bc1\u540c\u6b65\u662f\u5426\u4e00\u81f4",level:3},{value:"\u96c6\u7fa4\u7ef4\u62a4",id:"\u96c6\u7fa4\u7ef4\u62a4",level:2},{value:"1\u3001\u8868\u65e5\u5fd7\u4fdd\u7559\u8bbe\u7f6e",id:"1\u8868\u65e5\u5fd7\u4fdd\u7559\u8bbe\u7f6e",level:3},{value:"2\u3001\u51b7\u70ed\u5206\u79bb\u65b9\u6848",id:"2\u51b7\u70ed\u5206\u79bb\u65b9\u6848",level:3},{value:"3\u3001clickhouse\u6570\u636e\u76ee\u5f55\u5927\u5c0f\u7edf\u8ba1",id:"3clickhouse\u6570\u636e\u76ee\u5f55\u5927\u5c0f\u7edf\u8ba1",level:3}],d={toc:c},p="wrapper";function u(e){let{components:a,...t}=e;return(0,s.yg)(p,(0,n.A)({},d,t,{components:a,mdxType:"MDXLayout"}),(0,s.yg)("h2",{id:"clickhouse\u96c6\u7fa4\u90e8\u7f72"},"Clickhouse\u96c6\u7fa4\u90e8\u7f72"),(0,s.yg)("p",null,"\u5355\u673a\u90e8\u7f72"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},'\u5b89\u88c5clickhouse\nsudo apt-get install -y apt-transport-https ca-certificates dirmngr\nsudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 8919F6BD2B48D754\n\necho "deb [arch=amd64]  https://packages.clickhouse.com/deb stable main" | sudo tee \\\n    /etc/apt/sources.list.d/clickhouse.list\nsudo apt-get update\n\n#\u5b89\u88c5\u6307\u5b9a\u7248\u672c\napt-get install -y clickhouse-common-static="23.4.2.11"  clickhouse-server="23.4.2.11" clickhouse-client="23.4.2.11"\n\n\n\u6302\u8f7d\u5377:\nmount -t nfs -o nolock,proto=tcp,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport 172.19.35.5:/ossdata /mnt\n\nmkdir -p /mnt/clickhouse/\nchown clickhouse:clickhouse -R  /mnt/clickhouse\n\n\n\u4fee\u6539clickhouse\u7684\u914d\u7f6e\u6587\u4ef6\n\n\u628a\u9ed8\u8ba4\u76ee\u5f55/var/lib/clickhouse\u4fee\u6539\u4e3a  /mnt/clickhouse\nvim\u4e2d\u64cd\u4f5c:  /etc/clickhouse-server/config.xml\n:%s@/var/lib/clickhouse@/mnt/clickhouse@g\n\n\n\u91cd\u542fclickhouse\nsystemctl restart clickhouse-server\n\n\n\u6309\u7167\u5b98\u65b9\u5bfc\u5165\u6d4b\u8bd5\u6570\u636e\nhttps://clickhouse.com/docs/en/getting-started/example-datasets/star-schema\n')),(0,s.yg)("p",null,"\u603b\u7ed3\u6587\u6863\uff1a "),(0,s.yg)("p",null,(0,s.yg)("a",{parentName:"p",href:"https://blog.csdn.net/L13763338360/article/details/119210100"},"clickhouse\u642d\u5efa\u96c6\u7fa4\u95ee\u9898\u603b\u7ed3_clickhouse\u96c6\u7fa4\u6700\u5c11\u51e0\u4e2a\u8282\u70b9-CSDN\u535a\u5ba2")),(0,s.yg)("h2",{id:"dba\u65e5\u5e38\u64cd\u4f5c"},"DBA\u65e5\u5e38\u64cd\u4f5c"),(0,s.yg)("h3",{id:"\u5e38\u7528\u67e5\u8be2\u547d\u4ee4"},"\u5e38\u7528\u67e5\u8be2\u547d\u4ee4"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sql"},"use bjgsbp20200828\n\nSELECT * FROM GPSContDataH3  WHERE timestamp_column >= toDateTime('2023-01-01 00:00:00') AND timestamp_column < toDateTime('2023-01-02 00:00:00');\n\n\nSELECT * FROM GPSContDataH3  WHERE timestamp_column >= toDateTime('2022-12-30 00:00:00') AND timestamp_column < toDateTime('2022-12-31 00:00:00');\n\nSELECT * FROM GPSContDataH3 WHERE unix_time= toDateTime('2023-01-01 00:00:00', 'Asia/Istanbul')\n\n\nselect * from GPSContDataH3 order by unix_time desc limit 1 \\G\n\n\ntmux new -s  datazip\ntmux  attach -t \n\n121.36.244.174\n123.60.41.178\n\ntar zcvf  202307-202311.tar.gz ./202307new ./202308 ./202309 ./202310  ./202311\n\n\nnohup bash select.sh 1 > select.log 2>&1 &\nnohup bash select.sh 2 > select2.log 2>&1 &\n")),(0,s.yg)("h3",{id:"\u67e5\u770b\u6bcf\u4e2a\u5e93\u7684\u5927\u5c0f-\u6309\u7167\u5b9e\u9645\u5b57\u8282\u5c55\u793a"},"\u67e5\u770b\u6bcf\u4e2a\u5e93\u7684\u5927\u5c0f-\u6309\u7167\u5b9e\u9645\u5b57\u8282\u5c55\u793a"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"SELECT\n    database,\n    formatReadableSize(sum(data_compressed_bytes)) AS total_compressed_data_size\nFROM system.parts\nGROUP BY database\nORDER BY total_compressed_data_size DESC;\n")),(0,s.yg)("h3",{id:"\u67e5\u770b\u6bcf\u4e2a\u5e93\u7684\u5927\u5c0f-\u6309\u7167tib\u5355\u4f4d\u5c55\u793a"},"\u67e5\u770b\u6bcf\u4e2a\u5e93\u7684\u5927\u5c0f-\u6309\u7167TiB\u5355\u4f4d\u5c55\u793a"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"SELECT\n    database,\n    round(sum(data_compressed_bytes) / pow(1024, 3), 2) AS total_compressed_data_size_gib\nFROM system.parts\nGROUP BY database\nORDER BY total_compressed_data_size_gib DESC;\n")),(0,s.yg)("p",null,"select count(1) from bshdq20220123.StressData_local WHERE unix_time<toDateTime('2023-01-01 00:00:00', 'Asia/Istanbul')"),(0,s.yg)("h3",{id:"clickhouse\u6dfb\u52a0\u5bc6\u7801"},"clickhouse\u6dfb\u52a0\u5bc6\u7801"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"<clickhouse>\n    <users>\n        <default>\n            <password remove='1' />\n            <password_sha256_hex>e588fd15143cece8cde30db368df0fb75c2d6bd1c513c2896406f3193cf6ea75</password_sha256_hex>\n        </default>\n    </users>\n</clickhouse>\n")),(0,s.yg)("h3",{id:"\u67e5\u770b\u5355\u4e2a\u5e93\u7684\u603b\u5927\u5c0f"},"\u67e5\u770b\u5355\u4e2a\u5e93\u7684\u603b\u5927\u5c0f"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"SELECT\n    database,\n    round(sum(data_compressed_bytes) / pow(1024, 3), 2) AS total_compressed_data_size_gib\nFROM system.parts\nWHERE database = 'hthtdqjgjkjc20211203'\nGROUP BY database\nORDER BY total_compressed_data_size_gib DESC;\n\n\nSELECT\n        sum(rows) AS `\u603b\u884c\u6570`,\n        formatReadableSize(sum(data_uncompressed_bytes)) AS `\u539f\u59cb\u5927\u5c0f`,\n        formatReadableSize(sum(data_compressed_bytes)) AS `\u538b\u7f29\u5927\u5c0f`,\n        round(\n                (\n                        sum(data_compressed_bytes) / sum(data_uncompressed_bytes)\n                ) * 100,\n                0\n        ) AS `\u538b\u7f29\u7387`\nFROM\n        system.parts\nWHERE\n        database != 'system' and partition<='202312' and active=1\n")),(0,s.yg)("h3",{id:"\u67e5\u770b\u591a\u4e2a\u5e93\u7684\u5927\u5c0f"},"\u67e5\u770b\u591a\u4e2a\u5e93\u7684\u5927\u5c0f"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"SELECT\n    database,\n    round(sum(data_compressed_bytes) / pow(1024, 3), 2) AS total_compressed_data_size_gib\nFROM system.parts\nWHERE database IN ('hthtdqjgjkjc20211203', 'qhdxtmg20191124','chktdq20230531','xmgswhhtdqsljc20220526','ztjlskz20230420','tddl1')\nGROUP BY database\nORDER BY total_compressed_data_size_gib DESC;\n")),(0,s.yg)("h3",{id:"\u67e5\u770b\u5f53\u524d\u6570\u636e\u5e93\u6267\u884c\u7684\u8bed\u53e5"},"\u67e5\u770b\u5f53\u524d\u6570\u636e\u5e93\u6267\u884c\u7684\u8bed\u53e5"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sql"},"##delete\nselect * from system.query_log where type='Delete'  order by event_time desc limit 10 \\G;\n\n##alert -> delete\nselect * from system.query_log where query_kind='Alter'  order by event_time desc limit 10 \\G;\n")),(0,s.yg)("h3",{id:"\u67e5\u8be2\u5355\u4e2a\u5e93\u8868\u5927\u5c0f"},"\u67e5\u8be2\u5355\u4e2a\u5e93\u8868\u5927\u5c0f"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sql"},"SELECT\n        table AS `\u8868\u540d`,\n        sum(rows) AS `\u603b\u884c\u6570`,\n        formatReadableSize(sum(data_uncompressed_bytes)) AS `\u539f\u59cb\u5927\u5c0f`,\n        formatReadableSize(sum(data_compressed_bytes)) AS `\u538b\u7f29\u5927\u5c0f`,\n        round(\n                (\n                        sum(data_compressed_bytes) / sum(data_uncompressed_bytes)\n                ) * 100,\n                0\n        ) AS `\u538b\u7f29\u7387`\nFROM\n        system.parts\nWHERE\n        database = 'wzskdq20211109' -- table IN ('temp_1')\nGROUP BY\n        table;\n        \n")),(0,s.yg)("h3",{id:"\u67e5\u8be2\u591a\u4e2a\u5e93\u7684\u5927\u5c0f"},"\u67e5\u8be2\u591a\u4e2a\u5e93\u7684\u5927\u5c0f"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sql"},"        \nSELECT\n        database,\n        formatReadableSize (sum(bytes)) AS bytes_size,\n        formatReadableSize (sum(primary_key_bytes_in_memory)) AS primary_keys_size,\n        formatReadableSize (sum(data_uncompressed_bytes)) AS `\u539f\u59cb\u5927\u5c0f`,\n        formatReadableSize (sum(data_compressed_bytes)) AS `\u538b\u7f29\u5927\u5c0f`,\n        round(\n                (\n                        sum(data_compressed_bytes) / sum(data_uncompressed_bytes)\n                ) * 100,\n                0\n        ) AS `\u538b\u7f29\u7387`\nFROM\n        system.parts\nWHERE\n        1 = 1 AND database in ('ymgdq20230712')\nGROUP BY\n        database\nORDER BY\n        bytes_size DESC\nLIMIT\n        10;     \n")),(0,s.yg)("h3",{id:"\u67e5\u770b\u4e00\u4e2a\u5e93\u4e2d\u6240\u6709\u7684\u8868\u5927\u5c0f"},"\u67e5\u770b\u4e00\u4e2a\u5e93\u4e2d\u6240\u6709\u7684\u8868\u5927\u5c0f"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"SELECT \n    sum(rows) AS `\u603b\u884c\u6570`,\n    formatReadableSize(sum(data_uncompressed_bytes)) AS `\u539f\u59cb\u5927\u5c0f`,\n    formatReadableSize(sum(data_compressed_bytes)) AS `\u538b\u7f29\u5927\u5c0f`,\n    round((sum(data_compressed_bytes) / sum(data_uncompressed_bytes)) * 100, 0) AS `\u538b\u7f29\u7387`,\n    `table` AS `\u8868\u540d`\nFROM system.parts where database = 'bzhhdq20220906' group by `table`\n")),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sql"},"#\u8fc7\u6ee4\u6309\u7167\u5e74\u4efd - partition\nclickhouse-client --query=\"SELECT  partition,path,database  FROM system.parts where database = 'tzgjq20211109' and \\`table\\`= 'DistanceContData_local' and active and partition < '202301' ;\"\n")),(0,s.yg)("h3",{id:"\u67e5\u8be2\u6bcf\u4e2a\u5206\u533a\u4ee5\u53ca\u5b50\u8def\u52b2\u5360\u7528\u7a7a\u95f4"},"\u67e5\u8be2\u6bcf\u4e2a\u5206\u533a\u4ee5\u53ca\u5b50\u8def\u52b2\u5360\u7528\u7a7a\u95f4"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"SELECT\n    partition,\n    name,\n    bytes_on_disk / (1024 * 1024 * 1024) AS bytes_on_disk_gb,\n    path\nFROM system.parts\nWHERE database = 'yxhdq20211213' AND table = 'StressData_local';\n")),(0,s.yg)("h3",{id:"\u67e5\u770b\u6307\u5b9a\u5e93\u6bcf\u4e2a\u6708\u6bcf\u4e2a\u6708\u6240\u5360\u78c1\u76d8\u7684\u7a7a\u95f4"},"\u67e5\u770b\u6307\u5b9a\u5e93\u6bcf\u4e2a\u6708\u6bcf\u4e2a\u6708\u6240\u5360\u78c1\u76d8\u7684\u7a7a\u95f4"),(0,s.yg)("p",null,"(\u7d2f\u8ba1\u591a\u4e2a\u5206\u7247\u4e4b\u548c)"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"SELECT\n    database AS `\u9879\u76ee\u540d\u79f0`,\n    partition,\n    formatReadableSize(bytes_on_disk) AS `\u78c1\u76d8\u5360\u7528`,\n    formatReadableSize(data_uncompressed_bytes) AS `\u6570\u636e\u672a\u538b\u7f29/\u5b57\u8282`,\n    formatReadableSize(data_compressed_bytes) AS `\u6570\u636e\u538b\u7f29/\u5b57\u8282`,\n    compress_rate AS `\u538b\u7f29\u7387`,\n    rows AS `\u6570\u636e\u91cf/\u6761`\nFROM\n(\n    SELECT\n        database,\n        partition,\n        sum(rows) AS rows,\n        sum(bytes_on_disk) AS bytes_on_disk,\n        sum(data_uncompressed_bytes) AS data_uncompressed_bytes,\n        sum(data_compressed_bytes) AS data_compressed_bytes,\n        round((data_compressed_bytes / data_uncompressed_bytes) * 100, 2) AS compress_rate\n    FROM data_platform.system_parts\n    WHERE active AND (database = 'cqhhdgldq20230103')\n    GROUP BY\n        database,\n        partition\n)\nORDER BY partition ASC\n")),(0,s.yg)("p",null,(0,s.yg)("img",{parentName:"p",src:"https://iteshell.oss-cn-beijing.aliyuncs.com/bookshell/operator/image-20240328180443929.png",alt:"image-20240328180443929"})),(0,s.yg)("h3",{id:"\u67e5\u8be2\u6bcf\u4e2a\u5206\u533a\u6bcf\u4e2a\u6708-\u8868\u6240\u5360\u78c1\u76d8\u7a7a\u95f4\u7684\u603b\u548c-\u5355\u4f4dgb"},"\u67e5\u8be2\u6bcf\u4e2a\u5206\u533a(\u6bcf\u4e2a\u6708) \u8868\u6240\u5360\u78c1\u76d8\u7a7a\u95f4\u7684\u603b\u548c \u5355\u4f4dGB"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"SELECT \n    partition,\n    sum(bytes_on_disk) / (1024 * 1024 * 1024) AS bytes_on_disk_gb\nFROM system.parts\nWHERE database = 'bzhhdq20220906' AND table = 'TempHumiContData_local' and active and partition <= '202305' and partition >= '202305'  GROUP BY partition;\n\n\n")),(0,s.yg)("h3",{id:"\u67e5\u8be2\u6bcf\u6240\u6709\u5e93\u6bcf\u4e2a\u6708\u6240\u5360\u7684\u6570\u636e\u91cf"},"\u67e5\u8be2\u6bcf\u6240\u6709\u5e93\u6bcf\u4e2a\u6708\u6240\u5360\u7684\u6570\u636e\u91cf"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},'SELECT partition                                   AS "\u6708\u5ea6",\n       formatReadableSize(data_uncompressed_bytes) AS "\u6570\u636e\u672a\u538b\u7f29/\u5b57\u8282",\n       formatReadableSize(data_compressed_bytes)   AS "\u6570\u636e\u538b\u7f29/\u5b57\u8282",\n       concat(toString(compress_rate), \'%\')        AS "\u538b\u7f29\u6bd4\u7387",\n       formatReadableQuantity(rows)                AS "\u6570\u636e\u91cf/\u6761"\nFROM (\n      SELECT partition,\n             sum(rows)                    AS rows,\n             sum(bytes_on_disk)           AS bytes_on_disk,\n             sum(data_uncompressed_bytes) AS data_uncompressed_bytes,\n             sum(data_compressed_bytes)   AS data_compressed_bytes,\n             round((data_compressed_bytes / data_uncompressed_bytes) * 100,\n                   2)                    AS compress_rate\n      FROM data_platform.system_parts\n      WHERE active AND partition >= \'202401\' AND partition <= \'202403\' group by partition\n         ); \n')),(0,s.yg)("p",null,(0,s.yg)("img",{parentName:"p",src:"https://iteshell.oss-cn-beijing.aliyuncs.com/bookshell/operator/image-20240328180303181.png",alt:"image-20240328180303181"})),(0,s.yg)("h3",{id:"\u67e5\u770bclickhous\u5b9e\u4f8b\u6240\u5360\u78c1\u76d8\u603b\u7a7a\u95f4"},"\u67e5\u770bclickhous\u5b9e\u4f8b\u6240\u5360\u78c1\u76d8\u603b\u7a7a\u95f4"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"SELECT formatReadableSize(sum(bytes_on_disk)) AS total_data_size\nFROM system.parts\n")),(0,s.yg)("h3",{id:"\u67e5\u770b\u5206\u533a\u6240\u5728\u7684\u78c1\u76d8"},"\u67e5\u770b\u5206\u533a\u6240\u5728\u7684\u78c1\u76d8"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"\u67e5\u770b\u8868\u5206\u533a\u6240\u5728\u78c1\u76d8\nSELECT  partition,path,table,database  FROM system.parts where database = 'jhyhdq20230427' and `table`= 'DistanceContData_local' and active ;\n")),(0,s.yg)("h3",{id:"\u79fb\u52a8\u5206\u533a\u5230\u6307\u5b9a\u78c1\u76d8"},"\u79fb\u52a8\u5206\u533a\u5230\u6307\u5b9a\u78c1\u76d8"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"\u67e5\u770b\u78c1\u76d8\u540d\u79f0\nselect policy_name,volume_name,volume_priority,disks,volume_type,max_data_part_size from system.storage_policies;\nalter table bzhhdq20220906.StressData_local   move partition '202401' to DISK 'cloud_hdd_data4';\n")),(0,s.yg)("h3",{id:"\u6587\u4ef6\u5bfc\u51fa\u5bfc\u5165"},"\u6587\u4ef6\u5bfc\u51fa\u5bfc\u5165"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"csv\u6587\u4ef6\u5bfc\u51fa\nclickhouse-client  -q \"select * from bzhhdq20220906.TempHumiContData_distributed  where  unix_time > '2023-04-01 00:00:00' and unix_time < '2023-05-01 00:00:00'\" --format CSVWithNames > /root/bzhhdq20220906.TempHumiContData_distributed.csv\n\n\nclickhouse client -h 10.1.134.81 -u default  --query=\"insert into bzhhdq20220906.TempHumiContData_distributed FORMAT CSV\"< /opt/tableA.csv\n")),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sql"},"SELECT  partition,path,table,database  FROM system.parts where database = 'jnhhdegldq20200422' and `table`= 'TopInfoNodeData_local' and active ;\n\nroot@clickhouse04:~# clickhouse-client --query=\"SELECT  partition  FROM system.parts where database = 'jnhhdegldq20200422' and \\`table\\`= 'StressData_materialized_local' and active  and  partition < '202305' and partition > '202301' ;\"\n202302\n202302\n202303\n202303\n202303\n202304\n202304\n\n")),(0,s.yg)("p",null,(0,s.yg)("img",{parentName:"p",src:"https://iteshell.oss-cn-beijing.aliyuncs.com/bookshell/operator/image-20231117202442355.png",alt:"image-20231117202442355"})),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sql"},"alter table system.query_log drop partition '202311';\n\n#\u83b7\u53d6\u4e0a\u9762\u6267\u884c\u5b8c\u7684query_id\nselect * from system.query_log WHERE query_id='be797ab2-7363-4161-9209-c592ca359ea7' \\G;   #\u83b7\u53d6\u67e5\u8be2\u652f\u6301\u54ea\u4e9b\u5b57\u6bb5\n\nSELECT  partition,path,table,database  FROM system.parts where database = 'system' and `table`= 'query_log' and active ;\n")),(0,s.yg)("p",null,(0,s.yg)("img",{parentName:"p",src:"https://iteshell.oss-cn-beijing.aliyuncs.com/bookshell/operator/image-20231117202048652.png",alt:"image-20231117202048652"})),(0,s.yg)("p",null,"SELECT DISTINCT partition from  (SELECT  partition  FROM system.parts where database = 'jnhhdegldq20200422' and ",(0,s.yg)("inlineCode",{parentName:"p"},"table"),"= 'StressData_materialized_local' and active  and partition > '202301')  ORDER BY partition;"),(0,s.yg)("h3",{id:"clickhouse\u5f02\u6b65\u5904\u7406\u8bb0\u5f55"},"clickhouse\u5f02\u6b65\u5904\u7406\u8bb0\u5f55"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sql"},"select * from system.mutations limit 1\n")),(0,s.yg)("h3",{id:"\u67e5\u770b\u78c1\u76d8"},"\u67e5\u770b\u78c1\u76d8"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sql"},"SELECT\n        name,\n        path,\n        formatReadableSize (free_space) AS free,\n        formatReadableSize (total_space) AS total,\n        formatReadableSize (keep_free_space) AS reserved\nFROM\n        system.disks\n")),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"ekc04 :) select * from system.disks;\n\nSELECT *\nFROM system.disks\n\nQuery id: be502040-6263-4479-b6d4-64ca055ccf89\n\n\u250c\u2500name\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500path\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500free_space\u2500\u252c\u2500\u2500\u2500total_space\u2500\u252c\u2500unreserved_space\u2500\u252c\u2500keep_free_space\u2500\u252c\u2500type\u2500\u2500\u252c\u2500is_encrypted\u2500\u252c\u2500is_read_only\u2500\u252c\u2500is_write_once\u2500\u252c\u2500is_remote\u2500\u252c\u2500is_broken\u2500\u252c\u2500cache_path\u2500\u2510\n\u2502 cloud_hdd_data2 \u2502 /data2/container/clickhouse/      \u2502 469926281216 \u2502 1056758804480 \u2502     469926281216 \u2502               0 \u2502 local \u2502            0 \u2502            0 \u2502             0 \u2502         0 \u2502         0 \u2502            \u2502\n\u2502 cloud_hdd_data3 \u2502 /data3/container/clickhouse/      \u2502      1548288 \u2502 2113652535296 \u2502          1548288 \u2502               0 \u2502 local \u2502            0 \u2502            0 \u2502             0 \u2502         0 \u2502         0 \u2502            \u2502\n\u2502 cloud_hdd_data4 \u2502 /data4/container/clickhouse/      \u2502 519495372800 \u2502 3170543869952 \u2502     519495372800 \u2502               0 \u2502 local \u2502            0 \u2502            0 \u2502             0 \u2502         0 \u2502         0 \u2502            \u2502\n\u2502 default         \u2502 /data1/container/clickhouse/data/ \u2502  32945684480 \u2502  211243667456 \u2502      32945684480 \u2502               0 \u2502 local \u2502            0 \u2502            0 \u2502             0 \u2502         0 \u2502         0 \u2502            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n4 rows in set. Elapsed: 0.002 sec. \n")),(0,s.yg)("h3",{id:"\u67e5\u770b\u5b58\u50a8\u7b56\u7565"},"\u67e5\u770b\u5b58\u50a8\u7b56\u7565"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"ekc04 :) select * from system.storage_policies;\n\nSELECT *\nFROM system.storage_policies\n\nQuery id: 517044a2-d7f0-4e4d-bc1c-52ce3e80f161\n\n\u250c\u2500policy_name\u2500\u252c\u2500volume_name\u2500\u252c\u2500volume_priority\u2500\u252c\u2500disks\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500volume_type\u2500\u252c\u2500max_data_part_size\u2500\u252c\u2500move_factor\u2500\u252c\u2500prefer_not_to_merge\u2500\u252c\u2500perform_ttl_move_on_insert\u2500\u252c\u2500load_balancing\u2500\u2510\n\u2502 default     \u2502 default     \u2502               1 \u2502 ['default']         \u2502 JBOD        \u2502                  0 \u2502         0.1 \u2502                   0 \u2502                          1 \u2502 ROUND_ROBIN    \u2502\n\u2502 default     \u2502 data2       \u2502               2 \u2502 ['cloud_hdd_data2'] \u2502 JBOD        \u2502                  0 \u2502         0.1 \u2502                   0 \u2502                          1 \u2502 ROUND_ROBIN    \u2502\n\u2502 default     \u2502 data4       \u2502               3 \u2502 ['cloud_hdd_data4'] \u2502 JBOD        \u2502                  0 \u2502         0.1 \u2502                   0 \u2502                          1 \u2502 ROUND_ROBIN    \u2502\n\u2502 default     \u2502 data3       \u2502               4 \u2502 ['cloud_hdd_data3'] \u2502 JBOD        \u2502                  0 \u2502         0.1 \u2502                   0 \u2502                          1 \u2502 ROUND_ROBIN    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,s.yg)("p",null,(0,s.yg)("a",{parentName:"p",href:"https://www.cnblogs.com/wshenjin/p/14583918.html"},"clickhouse\u7684\u591a\u8def\u5f84\u5b58\u50a8\u7b56\u7565 - wshenJin - \u535a\u5ba2\u56ed (cnblogs.com)")),(0,s.yg)("h4",{id:"\u521b\u5efa\u6570\u636e\u5e93"},"\u521b\u5efa\u6570\u636e\u5e93"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"\nCREATE TABLE iteshell.test_local on cluster cluster_test ( \n    CounterID UInt32,  \n    StartDate Date,  \n    Sign Int8,  \n    IsNew UInt8,  \n    VisitID UInt64,  \n    UserID UInt64,  \n    StartTime DateTime\n) ENGINE = ReplicatedMergeTree('/clickhouse/tables/{shard}/iteshell.test_local', '{replica}') \nPARTITION BY toYYYYMM(StartDate) \nORDER BY (CounterID, StartDate, intHash32(UserID), VisitID) \nSAMPLE BY intHash32(UserID) \nSETTINGS index_granularity = 8192\n\n\n\n\ncreate table iteshell.test_all on cluster cluster_test  as iteshell.test_local \nENGINE = Distributed(cluster_test,iteshell,test_local,rand())\n\n\n#\u63d2\u5165\u6570\u636e\ninsert into iteshell.test_local values(1, '2023-12-20 00:11:22', 1, 1, 1, 11, toDateTime('2021-07-08 00:11:22'));\ninsert into iteshell.test_all values(1, '2023-12-02 00:11:22', 1, 1, 1, 11, toDateTime('2021-07-08 00:11:22'));\ninsert into iteshell.test_all values(1, '2023-12-03 00:11:22', 1, 1, 1, 11, toDateTime('2021-07-08 00:11:22'));\ninsert into iteshell.test_all values(1, '2023-12-05 00:11:22', 1, 1, 1, 11, toDateTime('2021-07-08 00:11:22'));\ninsert into iteshell.test_all values(1, '2023-12-06 00:11:22', 1, 1, 1, 11, toDateTime('2021-07-08 00:11:22'));\ninsert into iteshell.test_all values(1, '2023-12-08 00:11:22', 1, 1, 1, 11, toDateTime('2021-07-08 00:11:22'));\n")),(0,s.yg)("h3",{id:"\u67e5\u770breceive_timeout"},"\u67e5\u770breceive_timeout"),(0,s.yg)("p",null,"\u9ed8\u8ba4\u65f6\u95f4\u4e3a300s\uff0c\u53ef\u4ee5\u8c03\u6574\uff0c\u8c03\u6574\u65b9\u5f0f\u4e3a: "),(0,s.yg)("p",null,(0,s.yg)("img",{parentName:"p",src:"https://iteshell.oss-cn-beijing.aliyuncs.com/bookshell/operator/202401141524718.png",alt:null})),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre"},"        <receive_timeout>1800</receive_timeout>\n        <send_timeout>900</send_timeout>\n")),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"SELECT *\nFROM system.settings\nWHERE name = 'receive_timeout'\n")),(0,s.yg)("h3",{id:"clickhouse\u51b7\u70ed\u5206\u79bb"},"clickhouse\u51b7\u70ed\u5206\u79bb"),(0,s.yg)("p",null,(0,s.yg)("a",{parentName:"p",href:"https://cloud.tencent.com/developer/article/2187885"},"\u6280\u672f\u5206\u4eab | ClickHouse \u51b7\u70ed\u5b58\u50a8\u5206\u79bb\u65b9\u6848\u7ebf\u4e0a\u5b9e\u8df5-\u817e\u8baf\u4e91\u5f00\u53d1\u8005\u793e\u533a-\u817e\u8baf\u4e91 (tencent.com)")),(0,s.yg)("p",null,(0,s.yg)("a",{parentName:"p",href:"https://www.cnblogs.com/wshenjin/p/14583918.html"},"clickhouse\u7684\u591a\u8def\u5f84\u5b58\u50a8\u7b56\u7565 - wshenJin - \u535a\u5ba2\u56ed (cnblogs.com)")),(0,s.yg)("p",null,(0,s.yg)("a",{parentName:"p",href:"https://blog.csdn.net/weixin_45320660/article/details/114692892"},"ClickHouse\u591a\u5377\u5b58\u50a8\u7b56\u7565_clickhouse storage_policy-CSDN\u535a\u5ba2")),(0,s.yg)("h3",{id:"apk\u4fee\u6539\u6e90"},"apk\u4fee\u6539\u6e90"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-sql"},"sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories\n\napk update  #\u66f4\u65b0\napk add  busybox-extras  #\u5b89\u88c5telnet\napk add \u5b89\u88c5\u8f6f\u4ef6\n\napk del \u5220\u9664\u8f6f\u4ef6\n\napk upgrade \u5347\u7ea7\u8f6f\u4ef6\n\napk info \u5217\u51fa\u5df2\u5b89\u88c5\u7684\u8f6f\u4ef6\u4fe1\u606f\n\napk search \u901a\u8fc7\u540d\u5b57\u6216\u63cf\u8ff0\u641c\u7d22\u6709\u6ca1\u6709\u6539\u8f6f\u4ef6\n\napk fetch  \u4ece\u4ed3\u5e93\u4e0b\u8f7d\u8f6f\u4ef6\u5230\u672c\u5730\u76ee\u5f55\uff0c\u4e0b\u8f7d\u4e0b\u6765\u7684\u662f.apk\u5305\n")),(0,s.yg)("p",null,"consul snapshot save --http-addr=",(0,s.yg)("a",{parentName:"p",href:"http://10.12.142.216:8500"},"http://10.12.142.216:8500")," -token=b3a9bca3-6e8e-9678-ea35-ccb8fb272d42 consul",(0,s.yg)("em",{parentName:"p"},"state"),"$ts.snap"),(0,s.yg)("p",null,(0,s.yg)("img",{parentName:"p",src:"https://iteshell.oss-cn-beijing.aliyuncs.com/bookshell/operator/202401121115073.png",alt:null})),(0,s.yg)("p",null,(0,s.yg)("img",{parentName:"p",src:"https://iteshell.oss-cn-beijing.aliyuncs.com/bookshell/operator/202401121115073.png",alt:null})),(0,s.yg)("h2",{id:"clickhouse\u5907\u4efd\u548c\u8fd8\u539f"},"clickhouse\u5907\u4efd\u548c\u8fd8\u539f"),(0,s.yg)("h3",{id:"1remote"},"1\u3001Remote"),(0,s.yg)("p",null,"\u901a\u8fc7remote\u51fd\u6570\u5b9e\u73b0"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"clickhouse client  -h 172.x.x.x  --port  9000 -u default  --query=\"insert into ycssd1.ZHCARadarData_distributed  select *  from remote('172.x.x.x',ycssd1.ZHCARadarData_distributed,'default','')  where  unix_time > '2024-01-01 00:00:00' and unix_time < '2024-01-10 00:00:00';\"\n")),(0,s.yg)("h3",{id:"2clickhouse-copier--\u624b\u52a8\u65b9\u5f0f"},"2\u3001clickhouse copier -\u624b\u52a8\u65b9\u5f0f"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-xml"},'/data4/apache-zookeeper-3.6.3-bin/bin/zkCli.sh  -server 127.0.0.1:3181 create  /data/\n/data4/apache-zookeeper-3.6.3-bin/bin/zkCli.sh  -server 127.0.0.1:3181 create  /data/clickhouse/\n/data4/apache-zookeeper-3.6.3-bin/bin/zkCli.sh  -server 127.0.0.1:3181 create  /data/clickhouse/copytasks/\n/data4/apache-zookeeper-3.6.3-bin/bin/zkCli.sh  -server 127.0.0.1:3181 create  /data/clickhouse/copytasks/ztjlskz20230420\n/data4/apache-zookeeper-3.6.3-bin/bin/zkCli.sh  -server 127.0.0.1:3181 create  /data/clickhouse/copytasks/ztjlskz20230420/description   "`cat /root/clickhouse-copier/task/task-ztjlskz20230420-VibrationData_local.yaml`"\nclickhouse-copier  --config zookeeper.xml --task-path  /data/clickhouse/copytasks/ztjlskz20230420 --base-dir /root/clickhouse-copier/clickhouse-copier/ztjlskz20230420_VibrationData_local/\n\n#\u60f3\u5220\u9664node\u8282\u70b9\u4fe1\u606f\uff0c\u4f7f\u7528deleteall\n')),(0,s.yg)("p",null,"zookeeper\u914d\u7f6e\u6587\u4ef6"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-xml"},'<yandex>\n    <logger>\n        <level>trace</level>\n        <size>100M</size>\n        <count>3</count>\n    </logger>\n\n    <zookeeper>\n\n        <node index="1">\n            <host>172.19.49.39</host>\n            <port>3181</port>\n        </node>\n        <node index="2">\n            <host>172.19.49.40</host>\n            <port>3181</port>\n        </node>\n        <node index="3">\n            <host>172.19.49.41</host>\n            <port>3181</port>\n        </node>\n\n    </zookeeper>\n</yandex>\n')),(0,s.yg)("p",null,"task.yaml\u914d\u7f6e\u6587\u4ef6"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-xml"},"root@ekc01:~/clickhouse-copier# cat task/task-tongyong.yaml.bak \n<yandex>\n    <remote_servers>\n        <src_cluster>\n            <shard>\n                <internal_replication>true</internal_replication>\n                <weight>1</weight>\n                <replica>\n                    <host>ekc01</host>\n                    <port>9000</port>\n                    <user>default</user>\n                </replica>\n                <replica>\n                    <host>ekc02</host>\n                    <port>9000</port>\n                   <user>default</user>\n                </replica>\n            </shard>\n            <shard>\n            <internal_replication>true</internal_replication>\n                <weight>1</weight>\n                <replica>\n                    <host>ekc03</host>\n                    <port>9000</port>\n                    <user>default</user>\n                </replica>\n                <replica>\n                    <host>ekc04</host>\n                    <port>9000</port>\n                    <user>default</user>    \n                </replica>\n            </shard>\n        </src_cluster>\n        <dst_cluster>\n\n            <shard>\n                <internal_replication>true</internal_replication>\n                <weight>1</weight>\n                <replica>\n                    <host>172.19.49.62</host>\n                    <port>9000</port>\n                    <user>default</user>\n                </replica>\n                <replica>\n                    <host>172.19.49.63</host>\n                    <port>9000</port>\n                    <user>default</user>\n                </replica>\n            </shard>\n            <shard>\n            <internal_replication>true</internal_replication>\n                <weight>1</weight>\n                <replica>\n                    <host>172.19.49.64</host>\n                    <port>9000</port>\n                    <user>default</user>\n                </replica>\n                <replica>\n                    <host>172.19.49.65</host>\n                    <port>9000</port>\n                    <user>default</user>\n                </replica>\n            </shard>\n\n\n        </dst_cluster>\n    </remote_servers>\n    \x3c!-- \u6700\u5927worker\u6570 --\x3e\n    <max_workers>4</max_workers>\n    \x3c!-- fetch (pull) data \u8bbe\u7f6e\u4e3a\u53ea\u8bfb --\x3e\n    <settings_pull>\n        <readonly>1</readonly>\n    </settings_pull>\n    \x3c!-- insert (push) data \u8bbe\u7f6e\u4e3a\u8bfb\u5199 --\x3e\n    <settings_push>\n        <readonly>0</readonly>\n    </settings_push>\n\n    <settings>\n        <connect_timeout>999999999</connect_timeout>\n        <distributed_foreground_insert>1</distributed_foreground_insert> \n    </settings>\n    \n    \x3c!-- \u4efb\u52a1\u63cf\u8ff0\uff0c\u53ef\u4ee5\u914d\u7f6e\u591a\u4e2a\uff0c\u591a\u4e2a\u4efb\u52a1\u4f1a\u987a\u5e8f\u6267\u884c --\x3e\n    <tables>\n        \x3c!-- \u590d\u5236\u4efb\u52a1\uff0c\u540d\u5b57\u81ea\u5b9a\u4e49 --\x3e\n        \x3c!-- A table task, copies one table. --\x3e\n        <table_hits>\n            \x3c!-- Source cluster name (from <remote_servers/> section) and tables in it that should be copied --\x3e\n            <cluster_pull>src_cluster</cluster_pull>\n            <database_pull>src_database</database_pull>\n            <table_pull>src_local</table_pull>\n\n            \x3c!-- Destination cluster name and tables in which the data should be inserted --\x3e\n            <cluster_push>dst_cluster</cluster_push>\n            <database_push>dst_database</database_push>\n            <table_push>dst_local</table_push>\n\n            \x3c!-- Engine of destination tables.\n                 If destination tables have not be created, workers create them using columns definition from source tables and engine\n                 definition from here.\n\n                 NOTE: If the first worker starts insert data and detects that destination partition is not empty then the partition will\n                 be dropped and refilled, take it into account if you already have some data in destination tables. You could directly\n                 specify partitions that should be copied in <enabled_partitions/>, they should be in quoted format like partition column of\n                 system.parts table.\n            --\x3e\n            <engine>\n           ENGINE = ReplicatedReplacingMergeTree('/clickhouse/{layer}-{shard}/tables/\"dst_database\".dst_local', '{replica}', ver)\n           PARTITION BY toYYYYMM(unix_time)\n           ORDER BY (module_name, sensor_id, node_id, channel, unix_time, microsecond)\n           SETTINGS index_granularity = 8192\n            </engine>\n            \x3c!-- Sharding key used to insert data to destination cluster --\x3e\n            \x3c!-- <sharding_key>jumpConsistentHash(intHash64(UserID), 2)</sharding_key> --\x3e\n\n            \x3c!-- Optional expression that filter data while pull them from source servers --\x3e\n            \x3c!-- <where_condition>CounterID != 0</where_condition> --\x3e\n\n            \x3c!-- This section specifies partitions that should be copied, other partition will be ignored.\n                 Partition names should have the same format as\n                 partition column of system.parts table (i.e. a quoted text).\n                 Since partition key of source and destination cluster could be different,\n                 these partition names specify destination partitions.\n\n                 NOTE: In spite of this section is optional (if it is not specified, all partitions will be copied),\n                 it is strictly recommended to specify them explicitly.\n                 If you already have some ready partitions on destination cluster they\n                 will be removed at the start of the copying since they will be interpeted\n                 as unfinished data from the previous copying!!!\n            --\x3e\n            \n            <sharding_key>cityHash64(node_id)</sharding_key>  \n            \x3c!--\n            <enabled_partitions>\n                <partition>'888888'</partition>\n            </enabled_partitions>\n            --\x3e\n        </table_hits>\n\n        \x3c!-- Next table to copy. It is not copied until previous table is copying. --\x3e\n        \x3c!--\n        <table_visits>\n        </table_visits>\n        --\x3e\n\n     </tables>\n</yandex>\n\n")),(0,s.yg)("p",null,"\u6ce8\u610f\u7684\u70b9\uff1a "),(0,s.yg)("p",null," <sharding_key>cityHash64(node_id)</sharding_key>  #\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u8fdb\u884c\u8c03\u6574"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-xml"},"        <cluster_pull>src_cluster</cluster_pull>\n        <database_pull>src_database</database_pull>\n        <table_pull>src_local</table_pull>\n\n        \x3c!-- Destination cluster name and tables in which the data should be inserted --\x3e\n        <cluster_push>dst_cluster</cluster_push>\n        <database_push>dst_database</database_push>\n        <table_push>dst_local</table_push>\n")),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-xml"},"        <enabled_partitions>\n            <partition>'888888'</partition>\n        </enabled_partitions>\n")),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-xml"},"        <engine>\n       ENGINE = ReplicatedReplacingMergeTree('/clickhouse/{layer}-{shard}/tables/\"dst_database\".dst_local', '{replica}', ver)\n       PARTITION BY toYYYYMM(unix_time)\n       ORDER BY (module_name, sensor_id, node_id, channel, unix_time, microsecond)\n       SETTINGS index_granularity = 8192\n        </engine>\n")),(0,s.yg)("h3",{id:"3clickhouse-copier-\u811a\u672c"},"3\u3001clickhouse copier \u811a\u672c"),(0,s.yg)("p",null,"\u6307\u5b9a\u6570\u636e\u5e93\u548c\u8868"),(0,s.yg)("p",null,"\u62c9\u53d6\u4ee3\u7801"),(0,s.yg)("p",null,(0,s.yg)("a",{parentName:"p",href:"https://github.com/shouji1128955/bookcode.git"},"https://github.com/shouji1128955/bookcode.git")),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"#\u521b\u5efa\u4e00\u4e2a\u4efb\u52a1\u51fa\u6765\nbash  copy.sh  dbname\n\ncd dbname \nbash jilu.sh\nnohup bash run.sh &\n")),(0,s.yg)("p",null,"\u6ce8\u610f\uff1a worker\u5de5\u4f5c\u6570\u975e\u5e38\u91cd\u8981\uff0c\u5f71\u54cd\u4f20\u8f93\u7684\u65f6\u95f4"),(0,s.yg)("p",null,"\u4f20\u8f93\u5b8c\u6210\u4e4b\u540e\uff0c\u4f1a\u53d1\u9489\u9489\uff0c\u9700\u8981\u914d\u7f6e"),(0,s.yg)("p",null,"1\u3001\u67e5\u770b\u65e5\u5fd7nohup.out\uff0c\u67e5\u770bcopier\u7684\u65e5\u5fd7\uff0c\u6838\u5bf9errlog\u662f\u5426\u6b63\u5e38"),(0,s.yg)("p",null,"2\u3001\u6570\u636e\u5e93\u9700\u8981\u6838\u5bf9\uff0c\u662f\u5426count\u5bf9\u5f97\u4e0a"),(0,s.yg)("h3",{id:"4\u5728zookeeper\u9a8c\u8bc1\u540c\u6b65\u662f\u5426\u4e00\u81f4"},"4\u3001\u5728zookeeper\u9a8c\u8bc1\u540c\u6b65\u662f\u5426\u4e00\u81f4"),(0,s.yg)("p",null,"\u9996\u5148\u8fdb\u5165\u5230zk\u7684cli\u4e2d"),(0,s.yg)("p",null,"\u67e5\u770b\u5f53\u524d\u540c\u6b65\u7684\u72b6\u6001\uff0c\u4e0b\u9762\u53ef\u4ee5\u770b\u51fa\uff0c\u4e00\u5171\u67097\u4e2a\uff0c\u5f53\u524d\u6210\u529f\u4e3a6\u4e2a"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},'[zk: localhost:2181(CONNECTED) 81] get   /data/clickhouse/copytasks/chktdq20230531/VibrationData_local/status \n{"table_hits":{"all_partitions_count":7,"processed_partitions_count":6}}\n')),(0,s.yg)("p",null,"\u67e5\u770b\u662f\u5426\u540c\u6b65\u5b8c\u4e86"),(0,s.yg)("p",null,"\u4e0b\u9762\u8fd9\u79cd\u662f\u540c\u6b65\u5b8c\u7684"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"[zk: localhost:2181(CONNECTED) 77] get /data/clickhouse/copytasks/chktdq20230531/VibrationData_local/tables/dst_cluster.chktdq20230531.VibrationData_local/202310/attach_is_done \n1\nekc04#20240203123012_21621\n\n#\u6709\u8fd4\u56de\u503c\u662f1\u8fd9\u79cd\u5c5e\u4e8e\u540c\u6b65\u5b8c\u6210\n")),(0,s.yg)("p",null,"\u4e0b\u9762\u8fd9\u79cd\u662f\u6ca1\u6709\u540c\u6b65\u5b8c\u7684"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"[zk: localhost:2181(CONNECTED) 78] get /data/clickhouse/copytasks/chktdq20230531/VibrationData_local/tables/dst_cluster.chktdq20230531.VibrationData_local/202312/attach_is_done \nNode does not exist: /data/clickhouse/copytasks/chktdq20230531/VibrationData_local/tables/dst_cluster.chktdq20230531.VibrationData_local/202312/attach_is_done\n")),(0,s.yg)("h2",{id:"\u96c6\u7fa4\u7ef4\u62a4"},"\u96c6\u7fa4\u7ef4\u62a4"),(0,s.yg)("h3",{id:"1\u8868\u65e5\u5fd7\u4fdd\u7559\u8bbe\u7f6e"},"1\u3001\u8868\u65e5\u5fd7\u4fdd\u7559\u8bbe\u7f6e"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"ALTER table `system`.metric_log MODIFY TTL event_date + toIntervalDay(30);  #\u5bf9\u8868\u8bbe\u7f6e\u65e5\u5fd7\u4fdd\u7559\u65f6\u95f4\n")),(0,s.yg)("h3",{id:"2\u51b7\u70ed\u5206\u79bb\u65b9\u6848"},"2\u3001\u51b7\u70ed\u5206\u79bb\u65b9\u6848"),(0,s.yg)("p",null,"\u6b64\u5904\u63d0\u4f9b\u601d\u8def"),(0,s.yg)("p",null,"\u5b9e\u73b0\u5bf9obs(\u534e\u4e3a\u4e91\u5bf9\u8c61\u5b58\u50a8) \u6216\u8005oss+\u4e91\u7f51\u5173v3 \u6302\u8f7d\u5230\u670d\u52a1\u5668\u4e0a"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"-- \u521b\u5efa\u8868\u65f6\u6307\u5b9a\u5b58\u50a8\u7b56\u7565\u548cTTL\u8bbe\u7f6e\nCREATE TABLE my_table (\n    `date` Date,\n    `data` String\n) ENGINE = MergeTree()\nPARTITION BY date\nORDER BY date\nTTL date + INTERVAL 90 DAY TO VOLUME 'obs_volume'\nSETTINGS storage_policy = 'my_storage_policy'; \u7c7b\u4f3c\u8fd9\u79cd\n")),(0,s.yg)("ul",null,(0,s.yg)("li",{parentName:"ul"},"\u5728\u5f00\u6e90\u7684clickhouse\u7684\u914d\u7f6e\u5b9a\u4e49\u5b58\u50a8\u7b56\u7565\uff0c\u901a\u5e38\u5728clickhouse\u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u5b8c\u6210\uff0c\u9700\u8981\u6307\u5b9a\u672c\u5730\u78c1\u76d8\u548cOBS\u78c1\u76d8\u8def\u52b2"),(0,s.yg)("li",{parentName:"ul"},"\u63a5\u4e0b\u6765\u9700\u8981\u521b\u5efa clickhous\u8868\u65f6\uff0c\u4f7f\u7528SETTINGS storage_policy\u53c2\u6570\u6765\u6307\u5b9a\u4f60\u7684\u5b58\u50a8\u7b56\u7565\uff0c\u8fd9\u6837\uff0c\u5199\u5165\u7684\u6570\u636e\u9996\u5148\u5b58\u50a8\u5728\u672c\u5730\u78c1\u76d8\u4e0a\uff0c\u7136\u540e\u6839\u636eTTL\u89c4\u5219\u81ea\u52a8\u8fc1\u79fb\u5230OBS"),(0,s.yg)("li",{parentName:"ul"},"\u63a5\u4e0b\u91cc\u9700\u8981\u914d\u7f6eTTL\u8bbe\u7f6e\uff0c\u4f60\u53ef\u4ee5\u6307\u5b9a\u6570\u636e\u5728\u4e00\u5b9a\u65f6\u95f4\u540e\u81ea\u52a8\u4ece\u672c\u5730\u78c1\u76d8\u8fc1\u79fb\u5230OBS,\u4f8b\u5982\uff0c\u53ef\u4ee5\u8bbe\u7f6e90\u5929\u540e\u7684\u6570\u636e\u81ea\u52a8\u8fc1\u79fb.\uff08\u8fd9\u90e8\u5206\u6309\u7167\u4f60\u7684\u4e1a\u52a1\u903b\u8f91\u6765\u8bbe\u5b9a\u51b7\u70ed\u6570\u636e\u7684\u5b9a\u4e49) ")),(0,s.yg)("h3",{id:"3clickhouse\u6570\u636e\u76ee\u5f55\u5927\u5c0f\u7edf\u8ba1"},"3\u3001clickhouse\u6570\u636e\u76ee\u5f55\u5927\u5c0f\u7edf\u8ba1"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre",className:"language-shell"},"du -h --max-depth=3 | grep \"moving\"  |  awk '$1 ~ /G$/ && $1 > 10 {print}'\n")))}u.isMDXComponent=!0}}]);