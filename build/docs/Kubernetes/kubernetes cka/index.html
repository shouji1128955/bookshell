<!doctype html>
<html lang="zh-CN" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Kubernetes/kubernetes cka">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">kubernetes cka | LiteShell</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://docusaurus.io/zh-CN/img/undraw_typewriter.svg"><meta data-rh="true" name="twitter:image" content="https://docusaurus.io/zh-CN/img/undraw_typewriter.svg"><meta data-rh="true" property="og:url" content="https://book.zlqit.com/docs/Kubernetes/kubernetes cka"><meta data-rh="true" name="docusaurus_locale" content="zh-CN"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="kubernetes cka | LiteShell"><meta data-rh="true" name="description" content="1、RBAC权限控制"><meta data-rh="true" property="og:description" content="1、RBAC权限控制"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://book.zlqit.com/docs/Kubernetes/kubernetes cka"><link data-rh="true" rel="alternate" href="https://book.zlqit.com/docs/Kubernetes/kubernetes cka" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://book.zlqit.com/en/docs/Kubernetes/kubernetes cka" hreflang="en"><link data-rh="true" rel="alternate" href="https://book.zlqit.com/docs/Kubernetes/kubernetes cka" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="LiteShell RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="LiteShell Atom Feed"><link rel="stylesheet" href="/assets/css/styles.e0e0cc82.css">
<link rel="preload" href="/assets/js/runtime~main.bc5c38e0.js" as="script">
<link rel="preload" href="/assets/js/main.54222301.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="LiteShell" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="LiteShell" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">LiteShell</b></a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Sre</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/Sre/日常运维/operator">日常运维</a></li><li><a class="dropdown__link" href="/docs/Sre/中间件/Harbor">中间件</a></li><li><a class="dropdown__link" href="/docs/Sre/面试题/基础面试题">面试题</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Kubernetes</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/Kubernetes/日常操作命名">Kubernetes</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Prometheus</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/Prometheus/grafana/">grafana</a></li><li><a class="dropdown__link" href="/docs/Prometheus/prometheus/">Prometheus</a></li><li><a class="dropdown__link" href="/docs/Prometheus/alertManager/alertmanager告警配置">AlertManager</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">DevOps</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/DevOps/jenkins/jenkins安装配置/jenkins安装配置">jenkins</a></li><li><a class="dropdown__link" href="/docs/DevOps/gitOps/tekton安装">gitOps</a></li><li><a class="dropdown__link" href="/docs/DevOps/ELK/ELK测试部署">ELK</a></li><li><a class="dropdown__link" href="/docs/DevOps/skywalking/zookeeper安装">skywalking</a></li><li><a class="dropdown__link" href="/docs/DevOps/observability/OpenTelemetry/">observability</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Golang</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/Golang/golang基础/Go核心编程2023/golang">golang基础</a></li><li><a class="dropdown__link" href="/docs/Golang/golang进阶/gin框架2023/Gin框架">golang进阶</a></li><li><a class="dropdown__link" href="/docs/Golang/golang运维/项目1-Bingo/Bingo">golang运维</a></li><li><a class="dropdown__link" href="/docs/Golang/VUE/vue入门教程/vue入门教程1">Vue</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">JAVA</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/Java/JAVA/admin组件">Java</a></li></ul></div><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Kubernetes/日常操作命名">日常操作命名</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Kubernetes/affinity">affinity</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Kubernetes/helm">helm</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/Kubernetes/kubernetes cka">kubernetes cka</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Kubernetes/更新内核">更新内核</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Kubernetes/ansible安装k8s-1.24.12">ansible安装k8s-1.24.12</a></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">kubernetes cka</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>kubernetes cka</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1rbac权限控制">1、RBAC权限控制<a href="#1rbac权限控制" class="hash-link" aria-label="1、RBAC权限控制的直接链接" title="1、RBAC权限控制的直接链接">​</a></h2><p>Context </p><p>为部署流水线创建一个新的 ClusterRole 并将其绑定到范围为特定的 namespace 的特定 ServiceAccount。 </p><p>Task </p><p>创建一个名为 deployment-clusterrole 且仅允许创建以下资源类型的新 ClusterRole： </p><p>Deployment </p><p>StatefulSet</p><p>DaemonSet </p><p>在现有的 namespace app-team1 中创建一个名为 cicd-token 的新 ServiceAccount。 限于 namespace app-team1 中，将新的 ClusterRole deployment-clusterrole 绑定到新的 ServiceAccount cicd-token。</p><p>解答</p><p>#<!-- --> 题目中写了“限于 namespace app-team1 中”，则创建 rolebinding。没有写的话，则创建 clusterrolebinding。</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl  config use-context k8s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl  create clusterrole deployment-clusterrole3  --verb</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">create  --resource</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">deployments,statefulsets,daemonsets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl  create serviceaccount  cicd-token  -n app-team1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl  create rolebinding -n app-team1  cicd-token-rolebinding --clusterrole</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">deploy-clusterrole --serviceaccount</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">app-team1:cicd-token</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2查看pod的cpu">2、查看Pod的CPU<a href="#2查看pod的cpu" class="hash-link" aria-label="2、查看Pod的CPU的直接链接" title="2、查看Pod的CPU的直接链接">​</a></h2><p>#<!-- --> kubectl config use-context k8s </p><p>开始操作</p><p>#<!-- --> 查看 pod 名称 -A 是所有 namespace</p><p>kubectl top pod -l name=cpu-loader --sort-by=cpu -A</p><p>#<!-- --> 将 cpu 占用最多的 pod 的 name 写入/opt/test1.txt 文件</p><p>echo &quot;查出来的 Pod Name&quot; &gt; /opt/KUTR000401/KUTR00401.txt</p><p>检查</p><p>cat /opt/KUTR000401/KUTR00401.txt</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@node01:~</span><span class="token comment" style="color:#999988;font-style:italic"># kubectl  top pod -l name=cpu-loader --sort-by=cpu -A </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE   NAME                         CPU</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cores</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   MEMORY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cpu-top     redis-test-5db498bbd-h2mfj   1m           3Mi             </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cpu-top     nginx-host-c58757c-q6k74     0m           3Mi             </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cpu-top     test0-784f495b5c-2dqdv       0m           5Mi             </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@node01:~</span><span class="token comment" style="color:#999988;font-style:italic"># echo &#x27;redis-test-5db498bbd-h2mfj&#x27; &gt; /opt/KUTR000401/KUTR00401.txt </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@node01:~</span><span class="token comment" style="color:#999988;font-style:italic"># cat /opt/KUTR000401/KUTR00401.txt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redis-test-5db498bbd-h2mfj</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3配置网络策略-networkpolicy">3、配置网络策略 NetworkPolicy<a href="#3配置网络策略-networkpolicy" class="hash-link" aria-label="3、配置网络策略 NetworkPolicy的直接链接" title="3、配置网络策略 NetworkPolicy的直接链接">​</a></h2><p>设置配置环境：
<!-- -->[candidate@node-1]<!-- --> $ kubectl config use-context hk8s</p><p>Task
在现有的 namespace my-app 中创建一个名为 allow-port-from-namespace 的新 NetworkPolicy
确保新的 NetworkPolicy 允许 namespace echo 中的 Pods 连接到 namespace my-app 中的 Pods 的 9000 端口。</p><p>进一步确保新的 NetworkPolicy：
不允许对没有在监听 端口 9000 的 Pods 的访问
不允许非来自 namespace echo 中的 Pods 的访问</p><p>注解：</p><p>双重否定就是肯定，所以最后两句话的意思就是：
仅允许端口为 9000 的 pod 方法。
仅允许 echo 命名空间中的 pod 访问。</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@node01:~</span><span class="token comment" style="color:#999988;font-style:italic"># kubectl  config use-context k8s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@node01:~</span><span class="token comment" style="color:#999988;font-style:italic"># cat networkpolicy.yaml </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: NetworkPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: allow-port-from-namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: my-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  podSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels: </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  policyTypes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ingress:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - from:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - namespaceSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              project: </span><span class="token builtin class-name">echo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          port: </span><span class="token number" style="color:#36acaa">9000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@node01:~</span><span class="token comment" style="color:#999988;font-style:italic"># kubectl  apply -f networkpolicy.yaml          </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4暴露服务-service">4、暴露服务 service<a href="#4暴露服务-service" class="hash-link" aria-label="4、暴露服务 service的直接链接" title="4、暴露服务 service的直接链接">​</a></h2><p>Task</p><p>请重新配置现有的 deployment front-end 以及添加名为 http 的端口规范来公开现有容器 nginx 的端口 80/tcp。
创建一个名为 front-end-svc 的新 service，以公开容器端口 http
配置此 service，以通过各个 Pod 所在的节点上的 NodePort 来公开他们。</p><p>考点：将现有的 deploy 暴露成 nodeport 的 service。</p><p>参考链接 </p><p><a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/</a></p><p><img loading="lazy" src="/assets/images/1-3398cda04e2595e62d8648582c2ab803.jpg" width="777" height="586" class="img_ev3q"></p><p>参考下面进行编辑</p><p><img loading="lazy" src="/assets/images/2-6c7df2e1da870892a3d97aa51fd0d660.jpg" width="988" height="304" class="img_ev3q"></p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@node01:~</span><span class="token comment" style="color:#999988;font-style:italic"># kubectl  expose  deployment front-end --type=NodePort  --port=80  --target-port=80 --name=front-end-svc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>暴露后进行验证</p><p><img loading="lazy" src="/assets/images/3-144f327a9e8b512e80b784716097d438.jpg" width="919" height="127" class="img_ev3q"></p><p>确保 service 的 selector 标签与 deployment 的 selector 标签一致。如果不一致，可以通过编写yaml文件来实现。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">nodePort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">34001</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">targetPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">          //此处是重点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> front</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">end   //此处是重点</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="5创建ingress">5、创建ingress<a href="#5创建ingress" class="hash-link" aria-label="5、创建ingress的直接链接" title="5、创建ingress的直接链接">​</a></h2><p>Task
如下创建一个新的 nginx Ingress 资源：
名称: ping
Namespace: ing-internal
使用服务端口 5678 在路径 /hello 上公开服务 hello
可以使用以下命令检查服务 hello 的可用性，该命令应返回 hello：
curl -kL /hello</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@node01</span><span class="token punctuation" style="color:#393A34">:</span><span class="token null important">~</span><span class="token comment" style="color:#999988;font-style:italic"># cat ingress-class.yaml </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IngressClass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/component</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> controller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx               </span><span class="token comment" style="color:#999988;font-style:italic">#调整</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ingressclass.kubernetes.io/is-default-class</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;true&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">controller</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> k8s.io/ingress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#参考链接 https://kubernetes.io/docs/concepts/services-networking/ingress/#default-ingress-class</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@node01</span><span class="token punctuation" style="color:#393A34">:</span><span class="token null important">~</span><span class="token comment" style="color:#999988;font-style:italic"># cat ingress.yaml </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ping                         </span><span class="token comment" style="color:#999988;font-style:italic">#调整</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nginx.ingress.kubernetes.io/rewrite-target</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ing</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">internal            </span><span class="token comment" style="color:#999988;font-style:italic">#调整</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ingressClassName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx            </span><span class="token comment" style="color:#999988;font-style:italic">#调整</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">paths</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /hello                 </span><span class="token comment" style="color:#999988;font-style:italic">#调整</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">pathType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Prefix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">backend</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hello               </span><span class="token comment" style="color:#999988;font-style:italic">#调整</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">number</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5678</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">#调整</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#参考链接 https://kubernetes.io/docs/concepts/services-networking/ingress/              </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl  apply </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f ingress</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">class.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl  apply </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">f ingress.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>验证</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@node01:~</span><span class="token comment" style="color:#999988;font-style:italic"># kubectl  get ingress -n ing-internal</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME   CLASS   HOSTS   ADDRESS          PORTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ping</span><span class="token plain">   nginx   *       </span><span class="token number" style="color:#36acaa">10.105</span><span class="token plain">.186.107   </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">      4m7s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@node01:~</span><span class="token comment" style="color:#999988;font-style:italic"># curl  10.105.186.107/hello</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="6扩容deployment副本数量">6、扩容deployment副本数量<a href="#6扩容deployment副本数量" class="hash-link" aria-label="6、扩容deployment副本数量的直接链接" title="6、扩容deployment副本数量的直接链接">​</a></h2><p>考题:</p><p>Task
将 deployment presentation 扩展至 4 个 pods</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@node01:~</span><span class="token comment" style="color:#999988;font-style:italic"># kubectl  get deploy  -A  | grep  presentation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default            presentation              </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           99d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@node01:~</span><span class="token comment" style="color:#999988;font-style:italic"># kubectl  scale deploy presentation  --replicas=4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/presentation scaled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@node01:~</span><span class="token comment" style="color:#999988;font-style:italic"># kubectl  get deploy -A | grep presentation </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default            presentation              </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">/4     </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">           99d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="7调度pod到指定节点">7、调度pod到指定节点<a href="#7调度pod到指定节点" class="hash-link" aria-label="7、调度pod到指定节点的直接链接" title="7、调度pod到指定节点的直接链接">​</a></h2><p>Task
按如下要求调度一个 pod：</p><p>名称：nginx-kusc00401
Image：nginx
Node selector：disk=ssd</p><p>考点：nodeSelect 属性的使用</p><p>参考官网文档： </p><p><a href="https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/</a></p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@node01:~</span><span class="token comment" style="color:#999988;font-style:italic"># kubectl  run nginx-kusc00401  --image=nginx --dry-run=client -o yaml &gt; pod.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@node01:~</span><span class="token comment" style="color:#999988;font-style:italic"># cat pod.yaml </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  creationTimestamp: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    run: nginx-kusc00401</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: nginx-kusc00401</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - image: nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: nginx-kusc00401</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resources: </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nodeSelector:   </span><span class="token comment" style="color:#999988;font-style:italic">#添加此处</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    disk: ssd     </span><span class="token comment" style="color:#999988;font-style:italic">#添加此处</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dnsPolicy: ClusterFirst  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  restartPolicy: Always    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">status: </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@node01:~</span><span class="token comment" style="color:#999988;font-style:italic"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">验证：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@node01:~</span><span class="token comment" style="color:#999988;font-style:italic"># kubectl  get pods -A -o wide | grep  nginx-kusc00401</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default            nginx-kusc00401                            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">               42s   </span><span class="token number" style="color:#36acaa">10.244</span><span class="token plain">.196.163   node01     </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">           </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="8查看可用节点数量">8、查看可用节点数量<a href="#8查看可用节点数量" class="hash-link" aria-label="8、查看可用节点数量的直接链接" title="8、查看可用节点数量的直接链接">​</a></h2><p>Task
检查有多少 nodes 已准备就绪（不包括被打上 Taint：NoSchedule 的节点），
并将数量写入 /opt/KUSC00402/kusc00402.txt</p><p>因为题目要求，不包括被打上 Taint：NoSchedule 的就绪节点，所以要排除 NoSchedule 的</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@node01:~</span><span class="token comment" style="color:#999988;font-style:italic"># kubectl  describe nodes | grep -i Taints</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Taints:             node-role.kubernetes.io/control-plane:NoSchedule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Taints:             </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Taints:             </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@node01:~</span><span class="token comment" style="color:#999988;font-style:italic"># echo &quot;2&quot; &gt; /opt/KUSC00402/kusc00402.txt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="9创建多容器的-pod">9、创建多容器的 pod<a href="#9创建多容器的-pod" class="hash-link" aria-label="9、创建多容器的 pod的直接链接" title="9、创建多容器的 pod的直接链接">​</a></h2><p>[candidate@node-1]<!-- --> $ kubectl config use-context k8s Task </p><p>按如下要求调度一个 Pod： </p><p>名称：kucc8 app </p><p>containers: 2 </p><p>container 名称/images：</p><p> ⚫ nginx </p><p>⚫ consul</p><p>考点： 概念</p><p><a href="https://kubernetes.io/docs/concepts/workloads/pods/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/concepts/workloads/pods/</a></p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@node01</span><span class="token punctuation" style="color:#393A34">:</span><span class="token null important">~</span><span class="token comment" style="color:#999988;font-style:italic"># cat work-pod.yaml </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Pod </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kucc8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">1.14.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> consul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@node01</span><span class="token punctuation" style="color:#393A34">:</span><span class="token null important">~</span><span class="token comment" style="color:#999988;font-style:italic"># kubectl  get pods  kucc8 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME    READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kucc8   2/2     Running   0          13s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="10创建-pv">10、创建 PV<a href="#10创建-pv" class="hash-link" aria-label="10、创建 PV的直接链接" title="10、创建 PV的直接链接">​</a></h2><p>设置配置环境：
<!-- -->[candidate@node-1]<!-- --> $ kubectl config use-context hk8s
Task
创建名为 app-config 的 persistent volume，容量为 1Gi，访问模式为 ReadWriteMany。
volume 类型为 hostPath，位于 /srv/app-config</p><p>考点：hostPath 类型的 pv</p><p><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/</a></p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@node01:~</span><span class="token comment" style="color:#999988;font-style:italic"># cat pv.yaml  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: PersistentVolume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: app-config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">#labels:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">#  type: local</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">#storageClassName: manual</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  capacity:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage: 1Gi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  accessModes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - ReadWriteMany</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hostPath:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    path: </span><span class="token string" style="color:#e3116c">&quot;/srv/app-config&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="11创建-pvc">11、创建 PVC<a href="#11创建-pvc" class="hash-link" aria-label="11、创建 PVC的直接链接" title="11、创建 PVC的直接链接">​</a></h2><p> 考题</p><p>Task
创建一个新的 PersistentVolumeClaim：
名称: pv-volume
Class: csi-hostpath-sc
容量: 10Mi</p><p>创建一个新的 Pod，来将 PersistentVolumeClaim 作为 volume 进行挂载：
名称：web-server
Image：nginx:1.16
挂载路径：/usr/share/nginx/html</p><p>配置新的 Pod，以对 volume 具有 ReadWriteOnce 权限</p><p>最后，使用 kubectl edit 或 kubectl patch 将 PersistentVolumeClaim 的容量扩展为 70Mi，并记录此更改。</p><p><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/#create-a-persistentvolumeclaim" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/#create-a-persistentvolumeclaim</a></p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#创建pvc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">candidate@node01:~$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> pvc.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: PersistentVolumeClaim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: pv-volume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  storageClassName: csi-hostpath-sc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  accessModes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - ReadWriteOnce</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      storage: 10Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">candidate@node01:~$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> pvc-pod.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: web-server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: task-pv-storage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      persistentVolumeClaim:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        claimName: pv-volume  </span><span class="token comment" style="color:#999988;font-style:italic">#使用上面创建的pvc名字</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: task-pv-container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      image: nginx:1.16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#ports:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#  - containerPort: 80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#    name: &quot;http-server&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - mountPath: </span><span class="token string" style="color:#e3116c">&quot;/usr/share/nginx/html&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name: task-pv-storage</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>修改为70Mi </p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl  edit pvc pv-volume --record</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意，模拟环境是nfs,修改完后会报错。 考试环境没有报错</p><p><img loading="lazy" alt="image-20230829211832745" src="/assets/images/image-20230829211832745-e9aac181975dc1cb237eaba19a02983a.png" width="930" height="551" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="12查看-pod-日志">12、查看 pod 日志<a href="#12查看-pod-日志" class="hash-link" aria-label="12、查看 pod 日志的直接链接" title="12、查看 pod 日志的直接链接">​</a></h2><p>Task
监控 pod foo 的日志并：
提取与错误 RLIMIT_NOFILE
相对应的日志行 将这些日志行写入 /opt/KUTR00101/foo</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">candidate@node01:~$ kubectl  logs  foo </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;RLIMIT_NOFILE&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> /opt/KUTR00101/foo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="13使用-sidecar-代理容器日志">13、使用 sidecar 代理容器日志<a href="#13使用-sidecar-代理容器日志" class="hash-link" aria-label="13、使用 sidecar 代理容器日志的直接链接" title="13、使用 sidecar 代理容器日志的直接链接">​</a></h2><p>实际付款为162113.84 ，发票税率为13%，实际为8%, 计算实际发票金额为多少   </p><p>Context
将一个现有的 Pod 集成到 Kubernetes 的内置日志记录体系结构中（例如 kubectl logs）。
添加 streaming sidecar 容器是实现此要求的一种好方法。</p><p>Task
使用 busybox Image 来将名为 sidecar 的 sidecar 容器添加到现有的 Pod 11-factor-app 中。
新的 sidecar 容器必须运行以下命令：
/bin/sh -c tail -n+1 -f /var/log/11-factor-app.log 使用挂载在/var/log 的 Volume，
使日志文件 11-factor-app.log 可用于 sidecar 容器。 除了添加所需要的 volume mount 以外，请勿更改现有容器的规格。</p><p>考题翻译成白话，就是： 添加一个名为 sidecar 的边车容器(使用 busybox 镜像)，加到已有的 pod 11-factor-app 中。 确保 sidecar 容器能够输出 /var/log/11-factor-app.log 的信息。 使用 volume 挂载 /var/log 目录，确保 sidecar 能访问 11-factor-app.log 文件</p><p>官方链接： </p><p><a href="https://kubernetes.io/docs/concepts/cluster-administration/logging/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/concepts/cluster-administration/logging/</a></p><p>具体操作如下</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#从考试机器导出yaml配置文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl  get pods  </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">-factor-app -o yaml  </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> varlogs.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#然后删除pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">candidate@node01:~$ kubectl  delete pods </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">-factor-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#然后进行编辑</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">candidate@node01:~$ </span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> varlogs.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  creationTimestamp: </span><span class="token string" style="color:#e3116c">&quot;2023-05-20T14:22:47Z&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">-factor-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - /bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - -c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token assign-left variable" style="color:#36acaa">i</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">date</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c"> INFO </span><span class="token string variable" style="color:#36acaa">$i</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> /var/log/11-factor-app.log</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token assign-left variable" style="color:#36acaa">i</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$((</span><span class="token variable" style="color:#36acaa">i</span><span class="token variable operator" style="color:#393A34">+</span><span class="token variable number" style="color:#36acaa">1</span><span class="token variable" style="color:#36acaa">))</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: busybox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imagePullPolicy: IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name: count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resources: </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    terminationMessagePath: /dev/termination-log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    terminationMessagePolicy: File</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: kube-api-access-rlkbh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      readOnly: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">#添加部分  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: varlog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      mountPath: /var/log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">#添加部分  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: sidecar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: busybox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    imagePullPolicy: IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    args: </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">/bin/sh, -c, </span><span class="token string" style="color:#e3116c">&#x27;tail -n+1 -f /var/log/11-factor-app.log&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    volumeMounts:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: varlog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      mountPath: /var/log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dnsPolicy: ClusterFirst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  enableServiceLinks: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nodeName: node01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nodeSelector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubernetes.io/hostname: node01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  preemptionPolicy: PreemptLowerPriority</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  priority: </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  restartPolicy: Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  schedulerName: default-scheduler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  securityContext: </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serviceAccount: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serviceAccountName: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  terminationGracePeriodSeconds: </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tolerations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - effect: NoExecute</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    key: node.kubernetes.io/not-ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    operator: Exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tolerationSeconds: </span><span class="token number" style="color:#36acaa">300</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - effect: NoExecute</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    key: node.kubernetes.io/unreachable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    operator: Exists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tolerationSeconds: </span><span class="token number" style="color:#36acaa">300</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: kube-api-access-rlkbh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    projected:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      defaultMode: </span><span class="token number" style="color:#36acaa">420</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      sources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - serviceAccountToken:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expirationSeconds: </span><span class="token number" style="color:#36acaa">3607</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          path: token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - configMap:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          items:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - key: ca.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: ca.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          name: kube-root-ca.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - downwardAPI:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          items:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          - fieldRef:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              fieldPath: metadata.namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            path: namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">#添加部分        </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: varlog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    emptyDir: </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">candidate@node01:~$ kubectl apply -f varlogs.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#验证</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">candidate@node01:~$ kubectl  logs -f --tail</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token plain">-factor-app -c sidecar</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>清单文件配置参考</p><p>修改1</p><img loading="lazy" src="images/image-20230830000826070.png" alt="image-20230830000826070" class="img_ev3q"><p>修改2</p><p><img loading="lazy" src="http://minio.zlqit.com:80/file/202311052037258.png" alt="image-20230830000736618" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="14升级集群">14、升级集群<a href="#14升级集群" class="hash-link" aria-label="14、升级集群的直接链接" title="14、升级集群的直接链接">​</a></h2><p>Task
现有的 Kubernetes 集群正在运行版本 1.27.0。仅将 master 节点上的所有 Kubernetes 控制平面和节点组件升级到版本 1.27.1。</p><p>确保在升级之前 drain master 节点，并在升级后 uncordon master 节点。</p><p>可以使用以下命令，通过 ssh 连接到 master 节点：
ssh master01</p><p>可以使用以下命令，在该 master 节点上获取更高权限：</p><p>sudo -i
另外，在主节点上升级 kubelet 和 kubectl。</p><p>请不要升级工作节点，etcd，container 管理器,CNI 插件， DNS 服务或任何其他插件</p><p>（注意，考试敲命令时，注意要升级的版本，根据题目要求输入具体的升级版本！！！）</p><p>考点：如何离线主机，并升级控制面板和升级节点</p><p>解答 </p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># kubectl config use-context mk8s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># cordon 停止调度，将 node 调为 SchedulingDisabled。新 pod 不会被调度到该 node，但在该 node 的旧 pod 不受影响。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># drain 驱逐节点。首先，驱逐该 node 上的 pod，并在其他节点重新创建。接着，将节点调为 SchedulingDisabled。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 所以 kubectl cordon master01 这条，可写可不写。但我一向做事严谨，能复杂，就绝不简单了事。。。所以就写了</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">candidate@node01:~$ kubectl  cordon master01 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node/master01 cordoned</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">candidate@node01:~$ kubectl  get nodes </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME       STATUS                     ROLES           AGE    VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">master01   Ready,SchedulingDisabled   control-plane   101d   v1.27.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node01     Ready                      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">          101d   v1.27.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node02     Ready                      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">          101d   v1.27.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">candidate@node01:~$ kubectl  drain  master01 --ignore-daemonsets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">candidate@node01:~$ </span><span class="token function" style="color:#d73a49">ssh</span><span class="token plain"> master01</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">candidate@master01:~$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> -i </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@master01:~</span><span class="token comment" style="color:#999988;font-style:italic"># apt-get update</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@master01:~</span><span class="token comment" style="color:#999988;font-style:italic"># apt-cache show kubeadm | grep 1.27.1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Version: </span><span class="token number" style="color:#36acaa">1.27</span><span class="token plain">.1-00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Filename: pool/kubeadm_1.27.1-00_amd64_f18413bf4855208e88cec0d5ac6d4dca03242658bba61a293efbc9eb2b3c5ae6.deb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Filename: pool/kubeadm_1.25.5-00_amd64_2788155857bba8c7d3529df26085e4a174faec14171d2361dd49fe1e272198fc.deb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SHA256: 2788155857bba8c7d3529df26085e4a174faec14171d2361dd49fe1e272198fc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Filename: pool/kubeadm_1.12.8-00_amd64_be31c04079363054e2e112a38a87074b8468edac182781d1d5d9477149131ecb.deb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SHA256: be31c04079363054e2e112a38a87074b8468edac182781d1d5d9477149131ecb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@master01:~</span><span class="token comment" style="color:#999988;font-style:italic"># apt-get install kubeadm=1.27.1-00</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">截图是 </span><span class="token number" style="color:#36acaa">1.27</span><span class="token plain">.0 升级 </span><span class="token number" style="color:#36acaa">1.27</span><span class="token plain">.1 的</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20230830002214127" src="/assets/images/image-20230830002214127-c3432c4709d2353ddec48c6b46fb5dff.png" width="1916" height="1040" class="img_ev3q"></p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@master01:~</span><span class="token comment" style="color:#999988;font-style:italic"># kubeadm version</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm version: </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">version.Info</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Major:</span><span class="token string" style="color:#e3116c">&quot;1&quot;</span><span class="token plain">, Minor:</span><span class="token string" style="color:#e3116c">&quot;27&quot;</span><span class="token plain">, GitVersion:</span><span class="token string" style="color:#e3116c">&quot;v1.27.1&quot;</span><span class="token plain">, GitCommit:</span><span class="token string" style="color:#e3116c">&quot;4c9411232e10168d7b050c49a1b59f6df9d7ea4b&quot;</span><span class="token plain">, GitTreeState:</span><span class="token string" style="color:#e3116c">&quot;clean&quot;</span><span class="token plain">, BuildDate:</span><span class="token string" style="color:#e3116c">&quot;2023-04-14T13:20:04Z&quot;</span><span class="token plain">, GoVersion:</span><span class="token string" style="color:#e3116c">&quot;go1.20.3&quot;</span><span class="token plain">, Compiler:</span><span class="token string" style="color:#e3116c">&quot;gc&quot;</span><span class="token plain">, Platform:</span><span class="token string" style="color:#e3116c">&quot;linux/amd64&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 验证升级计划，会显示很多可升级的版本，我们关注题目要求升级到的那个版本。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@master01:~</span><span class="token comment" style="color:#999988;font-style:italic"># kubeadm upgrade plan</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 排除 etcd，升级其他的，提示时，输入 y。大约要等 5 分钟。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm upgrade apply v1.27.1 --etcd-upgrade</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20230830002710141" src="/assets/images/image-20230830002710141-4a9c4d5362e6b1f0ad80e831285e101d.png" width="1144" height="283" class="img_ev3q"></p><p>升级 kubelet</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@master01:~</span><span class="token comment" style="color:#999988;font-style:italic"># apt-get install kubelet=1.27.1-00</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@master01:~</span><span class="token comment" style="color:#999988;font-style:italic"># kubelet  --version </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kubernetes v1.27.1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>升级 kubectl</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@master01:~</span><span class="token comment" style="color:#999988;font-style:italic"># apt-get  install kubectl=1.27.1-00</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@master01:~</span><span class="token comment" style="color:#999988;font-style:italic"># kubectl  version </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WARNING: This version information is deprecated and will be replaced with the output from kubectl version --short.  Use --output</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">yaml</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">json to get the full version.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Client Version: version.Info</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Major:</span><span class="token string" style="color:#e3116c">&quot;1&quot;</span><span class="token plain">, Minor:</span><span class="token string" style="color:#e3116c">&quot;27&quot;</span><span class="token plain">, GitVersion:</span><span class="token string" style="color:#e3116c">&quot;v1.27.1&quot;</span><span class="token plain">, GitCommit:</span><span class="token string" style="color:#e3116c">&quot;4c9411232e10168d7b050c49a1b59f6df9d7ea4b&quot;</span><span class="token plain">, GitTreeState:</span><span class="token string" style="color:#e3116c">&quot;clean&quot;</span><span class="token plain">, BuildDate:</span><span class="token string" style="color:#e3116c">&quot;2023-04-14T13:21:19Z&quot;</span><span class="token plain">, GoVersion:</span><span class="token string" style="color:#e3116c">&quot;go1.20.3&quot;</span><span class="token plain">, Compiler:</span><span class="token string" style="color:#e3116c">&quot;gc&quot;</span><span class="token plain">, Platform:</span><span class="token string" style="color:#e3116c">&quot;linux/amd64&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kustomize Version: v5.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Server Version: version.Info</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Major:</span><span class="token string" style="color:#e3116c">&quot;1&quot;</span><span class="token plain">, Minor:</span><span class="token string" style="color:#e3116c">&quot;27&quot;</span><span class="token plain">, GitVersion:</span><span class="token string" style="color:#e3116c">&quot;v1.27.1&quot;</span><span class="token plain">, GitCommit:</span><span class="token string" style="color:#e3116c">&quot;4c9411232e10168d7b050c49a1b59f6df9d7ea4b&quot;</span><span class="token plain">, GitTreeState:</span><span class="token string" style="color:#e3116c">&quot;clean&quot;</span><span class="token plain">, BuildDate:</span><span class="token string" style="color:#e3116c">&quot;2023-04-14T13:14:42Z&quot;</span><span class="token plain">, GoVersion:</span><span class="token string" style="color:#e3116c">&quot;go1.20.3&quot;</span><span class="token plain">, Compiler:</span><span class="token string" style="color:#e3116c">&quot;gc&quot;</span><span class="token plain">, Platform:</span><span class="token string" style="color:#e3116c">&quot;linux/amd64&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>回退考试的初始节点candidate@node01</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@master01:~</span><span class="token comment" style="color:#999988;font-style:italic"># exit </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">logout</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">candidate@master01:~$ </span><span class="token builtin class-name">exit</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">logout</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connection to master01 closed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">candidate@node01:~$</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>恢复master01调度</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">candidate@node01:~$ kubectl  uncordon master01 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node/master01 uncordoned</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#检查 master01 是否为 Ready</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">candidate@node01:~$ kubectl  get </span><span class="token function" style="color:#d73a49">node</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME       STATUS   ROLES           AGE    VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">master01   Ready    control-plane   101d   v1.27.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node01     Ready    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">          101d   v1.27.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node02     Ready    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">          101d   v1.27.0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="15备份还原-etcd">15、备份还原 etcd<a href="#15备份还原-etcd" class="hash-link" aria-label="15、备份还原 etcd的直接链接" title="15、备份还原 etcd的直接链接">​</a></h2><p>设置配置环境
此项目无需更改配置环境。但是，在执行此项目之前，请确保您已返回初始节点。</p><p>[candidate@master01]<!-- --> $ exit #注意，这个之前是在 master01 上，所以要 exit 退到 node01，如果已经是 node01 了，就不要再 exit 了。</p><p>Task
首先，为运行在 <a href="https://11.0.1.111:2379" target="_blank" rel="noopener noreferrer">https://11.0.1.111:2379</a>  上的现有 etcd 实例创建快照并将快照保存到 /var/lib/backup/etcd-snapshot.db</p><p>（注意，真实考试中，这里写的是 <a href="https://127.0.0.1:2379%EF%BC%89" target="_blank" rel="noopener noreferrer">https://127.0.0.1:2379）</a></p><p>为给定实例创建快照预计能在几秒钟内完成。 如果该操作似乎挂起，则命令可能有问题。用 CTRL + C 来取消操作，然后重试。
然后还原位于/data/backup/etcd-snapshot-previous.db 的现有先前快照。
提供了以下 TLS 证书和密钥，以通过 etcdctl 连接到服务器。</p><p>CA 证书: /opt/KUIN00601/ca.crt
客户端证书: /opt/KUIN00601/etcd-client.crt
客户端密钥: /opt/KUIN00601/etcd-client.key</p><p>考点：etcd 的备份和还原命令</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">candidate@node01:~$ </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">ETCDCTL_API</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">candidate@node01:~$ etcdctl  --endpoints</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://11.0.1.111:2379 --cacert</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/opt/KUIN00601/ca.crt&quot;</span><span class="token plain"> --cert</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/opt/KUIN00601/etcd-client.crt&quot;</span><span class="token plain"> --key</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/opt/KUIN00601/etcd-client.key&quot;</span><span class="token plain">  snapshot save /var/lib/backup/etcd-snapshot.db </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;level&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;info&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;ts&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;2023-08-31T01:32:18.023+0800&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;caller&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;snapshot/v3_snapshot.go:65&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;msg&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;created temporary db file&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;path&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;/var/lib/backup/etcd-snapshot.db.part&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;level&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;info&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;ts&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;2023-08-31T01:32:18.032+0800&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;logger&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;client&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;caller&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;v3@v3.5.7/maintenance.go:212&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;msg&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;opened snapshot stream; downloading&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;level&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;info&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;ts&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;2023-08-31T01:32:18.032+0800&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;caller&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;snapshot/v3_snapshot.go:73&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;msg&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;fetching snapshot&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;endpoint&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;https://11.0.1.111:2379&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;level&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;info&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;ts&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;2023-08-31T01:32:18.183+0800&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;logger&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;client&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;caller&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;v3@v3.5.7/maintenance.go:220&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;msg&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;completed snapshot read; closing&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;level&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;info&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;ts&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;2023-08-31T01:32:18.192+0800&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;caller&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;snapshot/v3_snapshot.go:88&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;msg&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;fetched snapshot&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;endpoint&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;https://11.0.1.111:2379&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;size&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;9.8 MB&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;took&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;now&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;level&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;info&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;ts&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;2023-08-31T01:32:18.192+0800&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;caller&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;snapshot/v3_snapshot.go:97&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;msg&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;saved&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;path&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;/var/lib/backup/etcd-snapshot.db&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Snapshot saved at /var/lib/backup/etcd-snapshot.db</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">candidate@node01:~$ </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> -l /var/lib/backup/etcd-snapshot.db </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-rw-------+ </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> candidate candidate </span><span class="token number" style="color:#36acaa">9846816</span><span class="token plain"> Aug </span><span class="token number" style="color:#36acaa">31</span><span class="token plain"> 01:32 /var/lib/backup/etcd-snapshot.db</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>检查：（考试时，这些检查动作，都可以不做）
etcdctl snapshot status /var/lib/backup/etcd-snapshot.db -wtable</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">candidate@node01:~$ etcdctl  snapshot status  /var/lib/backup/etcd-snapshot.db    -wtable </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Deprecated: Use </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">etcdutl snapshot status</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> instead.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------+----------+------------+------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain">   HASH   </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> REVISION </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> TOTAL KEYS </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> TOTAL SIZE </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------+----------+------------+------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> 43bb1477 </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">245642</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">1627</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain">     </span><span class="token number" style="color:#36acaa">9.8</span><span class="token plain"> MB </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------+----------+------------+------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>还原：
#考试时，/data/backup/etcd-snapshot-previous.db 的权限应该是只有 root 可读，所以需要使用 sudo 命令。
#可以 ll /data/backup/etcd-snapshot-previous.db 检查一下读写权限和属主。</p><p>#<!-- --> 不加 sudo 会报错 permission denied， 上面执行了 export ETCDCTL_API=3 了，下面就可以不写 ETCDCTL_API=3d 的，另外还原也是可以不写证书的（--cacert --cert --key）。</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">candidate@node01:~$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain">  </span><span class="token assign-left variable" style="color:#36acaa">ETCDCTL_API</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> etcdctl  --endpoints</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://11.0.1.111:2379  snapshot restore /data/backup/etcd-snapshot-previous.db </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Deprecated: Use </span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">etcdutl snapshot restore</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"> instead.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">-08-31T01:37:47+08:00   info    snapshot/v3_snapshot.go:248 restoring snapshot  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;path&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/data/backup/etcd-snapshot-previous.db&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;wal-dir&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default.etcd/member/wal&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;data-dir&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default.etcd&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;snap-dir&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default.etcd/member/snap&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;stack&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;go.etcd.io/etcd/etcdutl/v3/snapshot.(*v3Manager).Restore</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string entity" style="color:#36acaa">\t</span><span class="token string" style="color:#e3116c">go.etcd.io/etcd/etcdutl/v3@v3.5.7/snapshot/v3_snapshot.go:254</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">go.etcd.io/etcd/etcdutl/v3/etcdutl.SnapshotRestoreCommandFunc</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string entity" style="color:#36acaa">\t</span><span class="token string" style="color:#e3116c">go.etcd.io/etcd/etcdutl/v3@v3.5.7/etcdutl/snapshot_command.go:147</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">go.etcd.io/etcd/etcdctl/v3/ctlv3/command.snapshotRestoreCommandFunc</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string entity" style="color:#36acaa">\t</span><span class="token string" style="color:#e3116c">go.etcd.io/etcd/etcdctl/v3/ctlv3/command/snapshot_command.go:129</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">github.com/spf13/cobra.(*Command).execute</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string entity" style="color:#36acaa">\t</span><span class="token string" style="color:#e3116c">github.com/spf13/cobra@v1.1.3/command.go:856</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">github.com/spf13/cobra.(*Command).ExecuteC</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string entity" style="color:#36acaa">\t</span><span class="token string" style="color:#e3116c">github.com/spf13/cobra@v1.1.3/command.go:960</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">github.com/spf13/cobra.(*Command).Execute</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string entity" style="color:#36acaa">\t</span><span class="token string" style="color:#e3116c">github.com/spf13/cobra@v1.1.3/command.go:897</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">go.etcd.io/etcd/etcdctl/v3/ctlv3.Start</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string entity" style="color:#36acaa">\t</span><span class="token string" style="color:#e3116c">go.etcd.io/etcd/etcdctl/v3/ctlv3/ctl.go:107</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">go.etcd.io/etcd/etcdctl/v3/ctlv3.MustStart</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string entity" style="color:#36acaa">\t</span><span class="token string" style="color:#e3116c">go.etcd.io/etcd/etcdctl/v3/ctlv3/ctl.go:111</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">main.main</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string entity" style="color:#36acaa">\t</span><span class="token string" style="color:#e3116c">go.etcd.io/etcd/etcdctl/v3/main.go:59</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string" style="color:#e3116c">runtime.main</span><span class="token string entity" style="color:#36acaa">\n</span><span class="token string entity" style="color:#36acaa">\t</span><span class="token string" style="color:#e3116c">runtime/proc.go:255&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">-08-31T01:37:47+08:00   info    membership/store.go:141 Trimming membership information from the backend</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">-08-31T01:37:47+08:00   info    membership/cluster.go:421   added member    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;cluster-id&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cdf818194e3a8c32&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;local-member-id&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;added-peer-id&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;8e9e05c52164694d&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;added-peer-peer-urls&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;http://localhost:2380&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">-08-31T01:37:47+08:00   info    snapshot/v3_snapshot.go:269 restored snapshot   </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;path&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/data/backup/etcd-snapshot-previous.db&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;wal-dir&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default.etcd/member/wal&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;data-dir&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default.etcd&quot;</span><span class="token plain">, </span><span class="token string" style="color:#e3116c">&quot;snap-dir&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default.etcd/member/snap&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>考试时，etcd 是在 node01 上运行的，所以考试时，考题里的网址写的是 <a href="https://127.0.0.1:2379%E3%80%82" target="_blank" rel="noopener noreferrer">https://127.0.0.1:2379。</a></p><p>但是模拟环境里，虽然也模拟在 node01 上面执行数据恢复，但 etcd 实际是在 master01 节点，所以还原实际没有真正效果的。 但是，考试时，执行上面的命令，是没有问题的。</p></blockquote><p>生产场景下，真正恢复的时候 是必须要先将 etcd data 目录清理掉或者移走，然后再去执行 snapshot restore，这时集群的数据就一定和 snapshot 备份中的数据 统一了。比如方法 3 的操作方法。 感谢网友善先生</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="16排查集群中故障节点">16、排查集群中故障节点<a href="#16排查集群中故障节点" class="hash-link" aria-label="16、排查集群中故障节点的直接链接" title="16、排查集群中故障节点的直接链接">​</a></h2><p>Task</p><p>名为 node02 的 Kubernetes worker node 处于 NotReady 状态。
调查发生这种情况的原因，并采取相应的措施将 node 恢复为 Ready 状态，确保所做的任何更改永久生效。</p><p>可以使用以下命令，通过 ssh 连接到 node02 节点：
ssh node02 可以使用以下命令，在该节点上获取更高权限：
sudo -i</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#登录node02节点，然后启动kubelet</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl start kubelet </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="17节点维护">17、节点维护<a href="#17节点维护" class="hash-link" aria-label="17、节点维护的直接链接" title="17、节点维护的直接链接">​</a></h2><p>Task</p><p>将名为 node02 的 node 设置为不可用，并重新调度该 node 上所有运行的 pods</p><p>考点：cordon 和 drain 命令的使用</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">candidate@node01:~$ kubectl  cordon node02 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node/node02 cordoned</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">candidate@node01:~$ kubectl  drain node02   --ignore-daemonsets  --delete-emptydir-data  --force </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>验证:</p><p>正常已经没有 pod 在 node02 上了。但测试环境里的 ingress、calico、kube-proxy 是 daemonsets 模式的，所以显示还在 node02 上，忽略即可。</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">candidate@node01:~$ kubectl  get pods -A -o wide </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> node02 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">calico-system      calico-node-9wv7w                          </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running            </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">28h ago</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">    102d   </span><span class="token number" style="color:#36acaa">11.0</span><span class="token plain">.1.113       node02     </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">           </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">calico-system      csi-node-driver-rsr2w                      </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">/2     Running            </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">28h ago</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   102d   </span><span class="token number" style="color:#36acaa">10.244</span><span class="token plain">.140.96    node02     </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">           </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ingress-nginx      ingress-nginx-controller-48m8c             </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running            </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">28h ago</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">    102d   </span><span class="token number" style="color:#36acaa">11.0</span><span class="token plain">.1.113       node02     </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">           </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kube-system        kube-proxy-xtm62                           </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running            </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">              25h    </span><span class="token number" style="color:#36acaa">11.0</span><span class="token plain">.1.113       node02     </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">           </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Kubernetes/4.kubernetes cka.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Kubernetes/helm"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">helm</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Kubernetes/更新内核"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">更新内核</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1rbac权限控制" class="table-of-contents__link toc-highlight">1、RBAC权限控制</a></li><li><a href="#2查看pod的cpu" class="table-of-contents__link toc-highlight">2、查看Pod的CPU</a></li><li><a href="#3配置网络策略-networkpolicy" class="table-of-contents__link toc-highlight">3、配置网络策略 NetworkPolicy</a></li><li><a href="#4暴露服务-service" class="table-of-contents__link toc-highlight">4、暴露服务 service</a></li><li><a href="#5创建ingress" class="table-of-contents__link toc-highlight">5、创建ingress</a></li><li><a href="#6扩容deployment副本数量" class="table-of-contents__link toc-highlight">6、扩容deployment副本数量</a></li><li><a href="#7调度pod到指定节点" class="table-of-contents__link toc-highlight">7、调度pod到指定节点</a></li><li><a href="#8查看可用节点数量" class="table-of-contents__link toc-highlight">8、查看可用节点数量</a></li><li><a href="#9创建多容器的-pod" class="table-of-contents__link toc-highlight">9、创建多容器的 pod</a></li><li><a href="#10创建-pv" class="table-of-contents__link toc-highlight">10、创建 PV</a></li><li><a href="#11创建-pvc" class="table-of-contents__link toc-highlight">11、创建 PVC</a></li><li><a href="#12查看-pod-日志" class="table-of-contents__link toc-highlight">12、查看 pod 日志</a></li><li><a href="#13使用-sidecar-代理容器日志" class="table-of-contents__link toc-highlight">13、使用 sidecar 代理容器日志</a></li><li><a href="#14升级集群" class="table-of-contents__link toc-highlight">14、升级集群</a></li><li><a href="#15备份还原-etcd" class="table-of-contents__link toc-highlight">15、备份还原 etcd</a></li><li><a href="#16排查集群中故障节点" class="table-of-contents__link toc-highlight">16、排查集群中故障节点</a></li><li><a href="#17节点维护" class="table-of-contents__link toc-highlight">17、节点维护</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://book.zlqit.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">LiteShell<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://kubernetes.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">kubernetes<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://mindoc.zlqit.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">mindoc<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/shouji1128955" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Blog Project - LiteShell</div></div></div></footer></div>
<script src="/assets/js/runtime~main.bc5c38e0.js"></script>
<script src="/assets/js/main.54222301.js"></script>
</body>
</html>