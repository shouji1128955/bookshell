"use strict";(self.webpackChunkbookshell=self.webpackChunkbookshell||[]).push([[5554],{3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>b});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function s(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?s(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},s=Object.keys(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var i=n.createContext({}),p=function(e){var t=n.useContext(i),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(i.Provider,{value:t},e.children)},d="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,s=e.originalType,i=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),d=p(a),u=r,b=d["".concat(i,".").concat(u)]||d[u]||m[u]||s;return a?n.createElement(b,l(l({ref:t},c),{},{components:a})):n.createElement(b,l({ref:t},c))}));function b(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var s=a.length,l=new Array(s);l[0]=u;var o={};for(var i in t)hasOwnProperty.call(t,i)&&(o[i]=t[i]);o.originalType=e,o[d]="string"==typeof e?e:r,l[1]=o;for(var p=2;p<s;p++)l[p]=a[p];return n.createElement.apply(null,l)}return n.createElement.apply(null,a)}u.displayName="MDXCreateElement"},58806:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>i,contentTitle:()=>l,default:()=>m,frontMatter:()=>s,metadata:()=>o,toc:()=>p});var n=a(87462),r=(a(67294),a(3905));const s={},l=void 0,o={unversionedId:"Sre/\u65e5\u5e38\u8fd0\u7ef4/\u65e5\u5e38\u64cd\u4f5c",id:"Sre/\u65e5\u5e38\u8fd0\u7ef4/\u65e5\u5e38\u64cd\u4f5c",title:"\u65e5\u5e38\u64cd\u4f5c",description:"\u5e38\u7528\u67e5\u8be2\u547d\u4ee4",source:"@site/docs/Sre/1-\u65e5\u5e38\u8fd0\u7ef4/6.\u65e5\u5e38\u64cd\u4f5c.md",sourceDirName:"Sre/1-\u65e5\u5e38\u8fd0\u7ef4",slug:"/Sre/\u65e5\u5e38\u8fd0\u7ef4/\u65e5\u5e38\u64cd\u4f5c",permalink:"/docs/Sre/\u65e5\u5e38\u8fd0\u7ef4/\u65e5\u5e38\u64cd\u4f5c",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Sre/1-\u65e5\u5e38\u8fd0\u7ef4/6.\u65e5\u5e38\u64cd\u4f5c.md",tags:[],version:"current",lastUpdatedBy:"zhanglaiqiang",lastUpdatedAt:1700132594,formattedLastUpdatedAt:"2023\u5e7411\u670816\u65e5",sidebarPosition:6,frontMatter:{},sidebar:"SreOper",previous:{title:"\u811a\u672c\u7ba1\u7406",permalink:"/docs/Sre/\u65e5\u5e38\u8fd0\u7ef4/\u811a\u672c\u7ba1\u7406"},next:{title:"conflunce\u5b89\u88c5",permalink:"/docs/Sre/\u65e5\u5e38\u8fd0\u7ef4/conflunce\u5b89\u88c5"}},i={},p=[{value:"\u5e38\u7528\u67e5\u8be2\u547d\u4ee4",id:"\u5e38\u7528\u67e5\u8be2\u547d\u4ee4",level:2},{value:"\u67e5\u770b\u5f53\u524d\u6570\u636e\u5e93\u6267\u884c\u7684\u8bed\u53e5",id:"\u67e5\u770b\u5f53\u524d\u6570\u636e\u5e93\u6267\u884c\u7684\u8bed\u53e5",level:2},{value:"\u67e5\u8be2\u5355\u4e2a\u5e93\u7684\u5927\u5c0f",id:"\u67e5\u8be2\u5355\u4e2a\u5e93\u7684\u5927\u5c0f",level:2},{value:"\u67e5\u8be2\u591a\u4e2a\u5e93\u7684\u5927\u5c0f",id:"\u67e5\u8be2\u591a\u4e2a\u5e93\u7684\u5927\u5c0f",level:2},{value:"\u67e5\u770b\u4e00\u4e2a\u5e93\u4e2d\u6240\u6709\u7684\u8868\u5927\u5c0f",id:"\u67e5\u770b\u4e00\u4e2a\u5e93\u4e2d\u6240\u6709\u7684\u8868\u5927\u5c0f",level:2},{value:"clickhouse\u5f02\u6b65\u5904\u7406\u8bb0\u5f55",id:"clickhouse\u5f02\u6b65\u5904\u7406\u8bb0\u5f55",level:2},{value:"\u67e5\u770b\u78c1\u76d8",id:"\u67e5\u770b\u78c1\u76d8",level:2},{value:"apk\u4fee\u6539\u6e90",id:"apk\u4fee\u6539\u6e90",level:2}],c={toc:p},d="wrapper";function m(e){let{components:t,...s}=e;return(0,r.kt)(d,(0,n.Z)({},c,s,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"\u5e38\u7528\u67e5\u8be2\u547d\u4ee4"},"\u5e38\u7528\u67e5\u8be2\u547d\u4ee4"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"use bjgsbp20200828\n\nSELECT * FROM GPSContDataH3  WHERE timestamp_column >= toDateTime('2023-01-01 00:00:00') AND timestamp_column < toDateTime('2023-01-02 00:00:00');\n\n\nSELECT * FROM GPSContDataH3  WHERE timestamp_column >= toDateTime('2022-12-30 00:00:00') AND timestamp_column < toDateTime('2022-12-31 00:00:00');\n\nSELECT * FROM GPSContDataH3 WHERE unix_time= toDateTime('2023-01-01 00:00:00', 'Asia/Istanbul')\n\n\nselect * from GPSContDataH3 order by unix_time desc limit 1 \\G\n\n\ntmux new -s  datazip\ntmux  attach -t \n\n121.36.244.174\n123.60.41.178\n\ntar zcvf  202307-202311.tar.gz ./202307new ./202308 ./202309 ./202310  ./202311\n\n\nnohup bash select.sh 1 > select.log 2>&1 &\nnohup bash select.sh 2 > select2.log 2>&1 &\n")),(0,r.kt)("p",null,"select count(1) from bshdq20220123.StressData_local WHERE unix_time<toDateTime('2023-01-01 00:00:00', 'Asia/Istanbul')"),(0,r.kt)("h2",{id:"\u67e5\u770b\u5f53\u524d\u6570\u636e\u5e93\u6267\u884c\u7684\u8bed\u53e5"},"\u67e5\u770b\u5f53\u524d\u6570\u636e\u5e93\u6267\u884c\u7684\u8bed\u53e5"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"##delete\nselect * from system.query_log where type='Delete'  order by event_time desc limit 10 \\G;\n\n##alert -> delete\nselect * from system.query_log where query_kind='Alter'  order by event_time desc limit 10 \\G;\n")),(0,r.kt)("h2",{id:"\u67e5\u8be2\u5355\u4e2a\u5e93\u7684\u5927\u5c0f"},"\u67e5\u8be2\u5355\u4e2a\u5e93\u7684\u5927\u5c0f"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n        table AS `\u8868\u540d`,\n        sum(rows) AS `\u603b\u884c\u6570`,\n        formatReadableSize(sum(data_uncompressed_bytes)) AS `\u539f\u59cb\u5927\u5c0f`,\n        formatReadableSize(sum(data_compressed_bytes)) AS `\u538b\u7f29\u5927\u5c0f`,\n        round(\n                (\n                        sum(data_compressed_bytes) / sum(data_uncompressed_bytes)\n                ) * 100,\n                0\n        ) AS `\u538b\u7f29\u7387`\nFROM\n        system.parts\nWHERE\n        database = 'wzskdq20211109' -- table IN ('temp_1')\nGROUP BY\n        table;\n        \n")),(0,r.kt)("h2",{id:"\u67e5\u8be2\u591a\u4e2a\u5e93\u7684\u5927\u5c0f"},"\u67e5\u8be2\u591a\u4e2a\u5e93\u7684\u5927\u5c0f"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"        \nSELECT\n        database,\n        formatReadableSize (sum(bytes)) AS bytes_size,\n        formatReadableSize (sum(primary_key_bytes_in_memory)) AS primary_keys_size,\n        formatReadableSize (sum(data_uncompressed_bytes)) AS `\u539f\u59cb\u5927\u5c0f`,\n        formatReadableSize (sum(data_compressed_bytes)) AS `\u538b\u7f29\u5927\u5c0f`,\n        round(\n                (\n                        sum(data_compressed_bytes) / sum(data_uncompressed_bytes)\n                ) * 100,\n                0\n        ) AS `\u538b\u7f29\u7387`\nFROM\n        system.parts\nWHERE\n        1 = 1 AND database in ('ymgdq20230712')\nGROUP BY\n        database\nORDER BY\n        bytes_size DESC\nLIMIT\n        10;     \n")),(0,r.kt)("h2",{id:"\u67e5\u770b\u4e00\u4e2a\u5e93\u4e2d\u6240\u6709\u7684\u8868\u5927\u5c0f"},"\u67e5\u770b\u4e00\u4e2a\u5e93\u4e2d\u6240\u6709\u7684\u8868\u5927\u5c0f"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"SELECT \n    sum(rows) AS `\u603b\u884c\u6570`,\n    formatReadableSize(sum(data_uncompressed_bytes)) AS `\u539f\u59cb\u5927\u5c0f`,\n    formatReadableSize(sum(data_compressed_bytes)) AS `\u538b\u7f29\u5927\u5c0f`,\n    round((sum(data_compressed_bytes) / sum(data_uncompressed_bytes)) * 100, 0) AS `\u538b\u7f29\u7387`,\n    `table` AS `\u8868\u540d`\nFROM system.parts where database = 'bzhhdq20220906' group by `table`\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"#\u8fc7\u6ee4\u6309\u7167\u5e74\u4efd - partition\nclickhouse-client --query=\"SELECT  partition,path,database  FROM system.parts where database = 'tzgjq20211109' and \\`table\\`= 'DistanceContData_local' and active and partition < '202301' ;\"\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT  partition,path,table,database  FROM system.parts where database = 'jnhhdegldq20200422' and `table`= 'TopInfoNodeData_local' and active ;\n\nroot@clickhouse04:~# clickhouse-client --query=\"SELECT  partition  FROM system.parts where database = 'jnhhdegldq20200422' and \\`table\\`= 'StressData_materialized_local' and active  and  partition < '202305' and partition > '202301' ;\"\n202302\n202302\n202303\n202303\n202303\n202304\n202304\n\n")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image-20231117202442355",src:a(6505).Z,width:"1228",height:"339"})),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"alter table system.query_log drop partition '202311';\n\n#\u83b7\u53d6\u4e0a\u9762\u6267\u884c\u5b8c\u7684query_id\nselect * from system.query_log WHERE query_id='be797ab2-7363-4161-9209-c592ca359ea7' \\G;   #\u83b7\u53d6\u67e5\u8be2\u652f\u6301\u54ea\u4e9b\u5b57\u6bb5\n\nSELECT  partition,path,table,database  FROM system.parts where database = 'system' and `table`= 'query_log' and active ;\n")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"image-20231117202048652",src:a(23989).Z,width:"1124",height:"151"})),(0,r.kt)("p",null,"SELECT DISTINCT partition from  (SELECT  partition  FROM system.parts where database = 'jnhhdegldq20200422' and ",(0,r.kt)("inlineCode",{parentName:"p"},"table"),"= 'StressData_materialized_local' and active  and partition > '202301')  ORDER BY partition;"),(0,r.kt)("h2",{id:"clickhouse\u5f02\u6b65\u5904\u7406\u8bb0\u5f55"},"clickhouse\u5f02\u6b65\u5904\u7406\u8bb0\u5f55"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"select * from system.mutations limit 1\n")),(0,r.kt)("h2",{id:"\u67e5\u770b\u78c1\u76d8"},"\u67e5\u770b\u78c1\u76d8"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n        name,\n        path,\n        formatReadableSize (free_space) AS free,\n        formatReadableSize (total_space) AS total,\n        formatReadableSize (keep_free_space) AS reserved\nFROM\n        system.disks\n")),(0,r.kt)("h2",{id:"apk\u4fee\u6539\u6e90"},"apk\u4fee\u6539\u6e90"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories\n\napk update  #\u66f4\u65b0\napk add  busybox-extras  #\u5b89\u88c5telnet\napk add \u5b89\u88c5\u8f6f\u4ef6\n\napk del \u5220\u9664\u8f6f\u4ef6\n\napk upgrade \u5347\u7ea7\u8f6f\u4ef6\n\napk info \u5217\u51fa\u5df2\u5b89\u88c5\u7684\u8f6f\u4ef6\u4fe1\u606f\n\napk search \u901a\u8fc7\u540d\u5b57\u6216\u63cf\u8ff0\u641c\u7d22\u6709\u6ca1\u6709\u6539\u8f6f\u4ef6\n\napk fetch  \u4ece\u4ed3\u5e93\u4e0b\u8f7d\u8f6f\u4ef6\u5230\u672c\u5730\u76ee\u5f55\uff0c\u4e0b\u8f7d\u4e0b\u6765\u7684\u662f.apk\u5305\n")),(0,r.kt)("p",null,"consul snapshot save --http-addr=",(0,r.kt)("a",{parentName:"p",href:"http://10.12.142.216:8500"},"http://10.12.142.216:8500")," -token=b3a9bca3-6e8e-9678-ea35-ccb8fb272d42 consul",(0,r.kt)("em",{parentName:"p"},"state"),"$ts.snap"))}m.isMDXComponent=!0},23989:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/image-20231117202048652-9c8b93a7a87c51e94b1490a9b6f51df5.png"},6505:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/image-20231117202442355-a325f0d74e6cc115ae0daf1491bbd96d.png"}}]);