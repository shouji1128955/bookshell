"use strict";(self.webpackChunkbookshell=self.webpackChunkbookshell||[]).push([[9031],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>k});var a=t(67294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function r(e,n){if(null==e)return{};var t,a,o=function(e,n){if(null==e)return{};var t,a,o={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var c=a.createContext({}),d=function(e){var n=a.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},p=function(e){var n=d(e.components);return a.createElement(c.Provider,{value:n},e.children)},i="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,o=e.mdxType,l=e.originalType,c=e.parentName,p=r(e,["components","mdxType","originalType","parentName"]),i=d(t),m=o,k=i["".concat(c,".").concat(m)]||i[m]||u[m]||l;return t?a.createElement(k,s(s({ref:n},p),{},{components:t})):a.createElement(k,s({ref:n},p))}));function k(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var l=t.length,s=new Array(l);s[0]=m;var r={};for(var c in n)hasOwnProperty.call(n,c)&&(r[c]=n[c]);r.originalType=e,r[i]="string"==typeof e?e:o,s[1]=r;for(var d=2;d<l;d++)s[d]=t[d];return a.createElement.apply(null,s)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},55457:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>u,frontMatter:()=>l,metadata:()=>r,toc:()=>d});var a=t(87462),o=(t(67294),t(3905));const l={},s=void 0,r={unversionedId:"Kubernetes/kubernetes cka",id:"Kubernetes/kubernetes cka",title:"kubernetes cka",description:"1\u3001RBAC\u6743\u9650\u63a7\u5236",source:"@site/docs/Kubernetes/4.kubernetes cka.md",sourceDirName:"Kubernetes",slug:"/Kubernetes/kubernetes cka",permalink:"/docs/Kubernetes/kubernetes cka",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Kubernetes/4.kubernetes cka.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{},sidebar:"Kubernetes",previous:{title:"helm",permalink:"/docs/Kubernetes/helm"},next:{title:"\u66f4\u65b0\u5185\u6838",permalink:"/docs/Kubernetes/\u66f4\u65b0\u5185\u6838"}},c={},d=[{value:"1\u3001RBAC\u6743\u9650\u63a7\u5236",id:"1rbac\u6743\u9650\u63a7\u5236",level:2},{value:"2\u3001\u67e5\u770bPod\u7684CPU",id:"2\u67e5\u770bpod\u7684cpu",level:2},{value:"3\u3001\u914d\u7f6e\u7f51\u7edc\u7b56\u7565 NetworkPolicy",id:"3\u914d\u7f6e\u7f51\u7edc\u7b56\u7565-networkpolicy",level:2},{value:"4\u3001\u66b4\u9732\u670d\u52a1 service",id:"4\u66b4\u9732\u670d\u52a1-service",level:2},{value:"5\u3001\u521b\u5efaingress",id:"5\u521b\u5efaingress",level:2},{value:"6\u3001\u6269\u5bb9deployment\u526f\u672c\u6570\u91cf",id:"6\u6269\u5bb9deployment\u526f\u672c\u6570\u91cf",level:2},{value:"7\u3001\u8c03\u5ea6pod\u5230\u6307\u5b9a\u8282\u70b9",id:"7\u8c03\u5ea6pod\u5230\u6307\u5b9a\u8282\u70b9",level:2},{value:"8\u3001\u67e5\u770b\u53ef\u7528\u8282\u70b9\u6570\u91cf",id:"8\u67e5\u770b\u53ef\u7528\u8282\u70b9\u6570\u91cf",level:2},{value:"9\u3001\u521b\u5efa\u591a\u5bb9\u5668\u7684 pod",id:"9\u521b\u5efa\u591a\u5bb9\u5668\u7684-pod",level:2},{value:"10\u3001\u521b\u5efa PV",id:"10\u521b\u5efa-pv",level:2},{value:"11\u3001\u521b\u5efa PVC",id:"11\u521b\u5efa-pvc",level:2},{value:"12\u3001\u67e5\u770b pod \u65e5\u5fd7",id:"12\u67e5\u770b-pod-\u65e5\u5fd7",level:2},{value:"13\u3001\u4f7f\u7528 sidecar \u4ee3\u7406\u5bb9\u5668\u65e5\u5fd7",id:"13\u4f7f\u7528-sidecar-\u4ee3\u7406\u5bb9\u5668\u65e5\u5fd7",level:2},{value:"14\u3001\u5347\u7ea7\u96c6\u7fa4",id:"14\u5347\u7ea7\u96c6\u7fa4",level:2},{value:"15\u3001\u5907\u4efd\u8fd8\u539f etcd",id:"15\u5907\u4efd\u8fd8\u539f-etcd",level:2},{value:"16\u3001\u6392\u67e5\u96c6\u7fa4\u4e2d\u6545\u969c\u8282\u70b9",id:"16\u6392\u67e5\u96c6\u7fa4\u4e2d\u6545\u969c\u8282\u70b9",level:2},{value:"17\u3001\u8282\u70b9\u7ef4\u62a4",id:"17\u8282\u70b9\u7ef4\u62a4",level:2}],p={toc:d},i="wrapper";function u(e){let{components:n,...l}=e;return(0,o.kt)(i,(0,a.Z)({},p,l,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"1rbac\u6743\u9650\u63a7\u5236"},"1\u3001RBAC\u6743\u9650\u63a7\u5236"),(0,o.kt)("p",null,"Context "),(0,o.kt)("p",null,"\u4e3a\u90e8\u7f72\u6d41\u6c34\u7ebf\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 ClusterRole \u5e76\u5c06\u5176\u7ed1\u5b9a\u5230\u8303\u56f4\u4e3a\u7279\u5b9a\u7684 namespace \u7684\u7279\u5b9a ServiceAccount\u3002 "),(0,o.kt)("p",null,"Task "),(0,o.kt)("p",null,"\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a deployment-clusterrole \u4e14\u4ec5\u5141\u8bb8\u521b\u5efa\u4ee5\u4e0b\u8d44\u6e90\u7c7b\u578b\u7684\u65b0 ClusterRole\uff1a "),(0,o.kt)("p",null,"Deployment "),(0,o.kt)("p",null,"StatefulSet"),(0,o.kt)("p",null,"DaemonSet "),(0,o.kt)("p",null,"\u5728\u73b0\u6709\u7684 namespace app-team1 \u4e2d\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a cicd-token \u7684\u65b0 ServiceAccount\u3002 \u9650\u4e8e namespace app-team1 \u4e2d\uff0c\u5c06\u65b0\u7684 ClusterRole deployment-clusterrole \u7ed1\u5b9a\u5230\u65b0\u7684 ServiceAccount cicd-token\u3002"),(0,o.kt)("p",null,"\u89e3\u7b54"),(0,o.kt)("p",null,"#"," \u9898\u76ee\u4e2d\u5199\u4e86\u201c\u9650\u4e8e namespace app-team1 \u4e2d\u201d\uff0c\u5219\u521b\u5efa rolebinding\u3002\u6ca1\u6709\u5199\u7684\u8bdd\uff0c\u5219\u521b\u5efa clusterrolebinding\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl  config use-context k8s\nkubectl  create clusterrole deployment-clusterrole3  --verb=create  --resource=deployments,statefulsets,daemonsets\nkubectl  create serviceaccount  cicd-token  -n app-team1\nkubectl  create rolebinding -n app-team1  cicd-token-rolebinding --clusterrole=deploy-clusterrole --serviceaccount=app-team1:cicd-token\n")),(0,o.kt)("h2",{id:"2\u67e5\u770bpod\u7684cpu"},"2\u3001\u67e5\u770bPod\u7684CPU"),(0,o.kt)("p",null,"#"," kubectl config use-context k8s "),(0,o.kt)("p",null,"\u5f00\u59cb\u64cd\u4f5c"),(0,o.kt)("p",null,"#"," \u67e5\u770b pod \u540d\u79f0 -A \u662f\u6240\u6709 namespace"),(0,o.kt)("p",null,"kubectl top pod -l name=cpu-loader --sort-by=cpu -A"),(0,o.kt)("p",null,"#"," \u5c06 cpu \u5360\u7528\u6700\u591a\u7684 pod \u7684 name \u5199\u5165/opt/test1.txt \u6587\u4ef6"),(0,o.kt)("p",null,'echo "\u67e5\u51fa\u6765\u7684 Pod Name" > /opt/KUTR000401/KUTR00401.txt'),(0,o.kt)("p",null,"\u68c0\u67e5"),(0,o.kt)("p",null,"cat /opt/KUTR000401/KUTR00401.txt"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"root@node01:~# kubectl  top pod -l name=cpu-loader --sort-by=cpu -A \nNAMESPACE   NAME                         CPU(cores)   MEMORY(bytes)   \ncpu-top     redis-test-5db498bbd-h2mfj   1m           3Mi             \ncpu-top     nginx-host-c58757c-q6k74     0m           3Mi             \ncpu-top     test0-784f495b5c-2dqdv       0m           5Mi             \nroot@node01:~# echo 'redis-test-5db498bbd-h2mfj' > /opt/KUTR000401/KUTR00401.txt \nroot@node01:~# cat /opt/KUTR000401/KUTR00401.txt\nredis-test-5db498bbd-h2mfj\n")),(0,o.kt)("h2",{id:"3\u914d\u7f6e\u7f51\u7edc\u7b56\u7565-networkpolicy"},"3\u3001\u914d\u7f6e\u7f51\u7edc\u7b56\u7565 NetworkPolicy"),(0,o.kt)("p",null,"\u8bbe\u7f6e\u914d\u7f6e\u73af\u5883\uff1a\n","[candidate@node-1]"," $ kubectl config use-context hk8s"),(0,o.kt)("p",null,"Task\n\u5728\u73b0\u6709\u7684 namespace my-app \u4e2d\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a allow-port-from-namespace \u7684\u65b0 NetworkPolicy\n\u786e\u4fdd\u65b0\u7684 NetworkPolicy \u5141\u8bb8 namespace echo \u4e2d\u7684 Pods \u8fde\u63a5\u5230 namespace my-app \u4e2d\u7684 Pods \u7684 9000 \u7aef\u53e3\u3002"),(0,o.kt)("p",null,"\u8fdb\u4e00\u6b65\u786e\u4fdd\u65b0\u7684 NetworkPolicy\uff1a\n\u4e0d\u5141\u8bb8\u5bf9\u6ca1\u6709\u5728\u76d1\u542c \u7aef\u53e3 9000 \u7684 Pods \u7684\u8bbf\u95ee\n\u4e0d\u5141\u8bb8\u975e\u6765\u81ea namespace echo \u4e2d\u7684 Pods \u7684\u8bbf\u95ee"),(0,o.kt)("p",null,"\u6ce8\u89e3\uff1a"),(0,o.kt)("p",null,"\u53cc\u91cd\u5426\u5b9a\u5c31\u662f\u80af\u5b9a\uff0c\u6240\u4ee5\u6700\u540e\u4e24\u53e5\u8bdd\u7684\u610f\u601d\u5c31\u662f\uff1a\n\u4ec5\u5141\u8bb8\u7aef\u53e3\u4e3a 9000 \u7684 pod \u65b9\u6cd5\u3002\n\u4ec5\u5141\u8bb8 echo \u547d\u540d\u7a7a\u95f4\u4e2d\u7684 pod \u8bbf\u95ee\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"root@node01:~# kubectl  config use-context k8s\nroot@node01:~# cat networkpolicy.yaml \napiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: allow-port-from-namespace\n  namespace: my-app\nspec:\n  podSelector:\n    matchLabels: {}\n  policyTypes:\n    - Ingress\n  ingress:\n    - from:\n        - namespaceSelector:\n            matchLabels:\n              project: echo\n      ports:\n        - protocol: TCP\n          port: 9000\n          \nroot@node01:~# kubectl  apply -f networkpolicy.yaml          \n")),(0,o.kt)("h2",{id:"4\u66b4\u9732\u670d\u52a1-service"},"4\u3001\u66b4\u9732\u670d\u52a1 service"),(0,o.kt)("p",null,"Task"),(0,o.kt)("p",null,"\u8bf7\u91cd\u65b0\u914d\u7f6e\u73b0\u6709\u7684 deployment front-end \u4ee5\u53ca\u6dfb\u52a0\u540d\u4e3a http \u7684\u7aef\u53e3\u89c4\u8303\u6765\u516c\u5f00\u73b0\u6709\u5bb9\u5668 nginx \u7684\u7aef\u53e3 80/tcp\u3002\n\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a front-end-svc \u7684\u65b0 service\uff0c\u4ee5\u516c\u5f00\u5bb9\u5668\u7aef\u53e3 http\n\u914d\u7f6e\u6b64 service\uff0c\u4ee5\u901a\u8fc7\u5404\u4e2a Pod \u6240\u5728\u7684\u8282\u70b9\u4e0a\u7684 NodePort \u6765\u516c\u5f00\u4ed6\u4eec\u3002"),(0,o.kt)("p",null,"\u8003\u70b9\uff1a\u5c06\u73b0\u6709\u7684 deploy \u66b4\u9732\u6210 nodeport \u7684 service\u3002"),(0,o.kt)("p",null,"\u53c2\u8003\u94fe\u63a5 "),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/workloads/controllers/deployment/"},"https://kubernetes.io/docs/concepts/workloads/controllers/deployment/")),(0,o.kt)("p",null,(0,o.kt)("img",{src:t(21583).Z,width:"777",height:"586"})),(0,o.kt)("p",null,"\u53c2\u8003\u4e0b\u9762\u8fdb\u884c\u7f16\u8f91"),(0,o.kt)("p",null,(0,o.kt)("img",{src:t(15410).Z,width:"988",height:"304"})),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"root@node01:~# kubectl  expose  deployment front-end --type=NodePort  --port=80  --target-port=80 --name=front-end-svc\n")),(0,o.kt)("p",null,"\u66b4\u9732\u540e\u8fdb\u884c\u9a8c\u8bc1"),(0,o.kt)("p",null,(0,o.kt)("img",{src:t(44081).Z,width:"919",height:"127"})),(0,o.kt)("p",null,"\u786e\u4fdd service \u7684 selector \u6807\u7b7e\u4e0e deployment \u7684 selector \u6807\u7b7e\u4e00\u81f4\u3002\u5982\u679c\u4e0d\u4e00\u81f4\uff0c\u53ef\u4ee5\u901a\u8fc7\u7f16\u5199yaml\u6587\u4ef6\u6765\u5b9e\u73b0\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"ports:\n- nodePort: 34001\n  port: 80\n  protocol: TCP\n  targetPort: 80\nselector:          //\u6b64\u5904\u662f\u91cd\u70b9\n  app: front-end   //\u6b64\u5904\u662f\u91cd\u70b9\n")),(0,o.kt)("h2",{id:"5\u521b\u5efaingress"},"5\u3001\u521b\u5efaingress"),(0,o.kt)("p",null,"Task\n\u5982\u4e0b\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 nginx Ingress \u8d44\u6e90\uff1a\n\u540d\u79f0: ping\nNamespace: ing-internal\n\u4f7f\u7528\u670d\u52a1\u7aef\u53e3 5678 \u5728\u8def\u5f84 /hello \u4e0a\u516c\u5f00\u670d\u52a1 hello\n\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u68c0\u67e5\u670d\u52a1 hello \u7684\u53ef\u7528\u6027\uff0c\u8be5\u547d\u4ee4\u5e94\u8fd4\u56de hello\uff1a\ncurl -kL /hello"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'root@node01:~# cat ingress-class.yaml \napiVersion: networking.k8s.io/v1\nkind: IngressClass\nmetadata:\n  labels:\n    app.kubernetes.io/component: controller\n  name: nginx               #\u8c03\u6574\n  annotations:\n    ingressclass.kubernetes.io/is-default-class: "true"\nspec:\n  controller: k8s.io/ingress-nginx\n  \n\n#\u53c2\u8003\u94fe\u63a5 https://kubernetes.io/docs/concepts/services-networking/ingress/#default-ingress-class\nroot@node01:~# cat ingress.yaml \napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: ping                         #\u8c03\u6574\n  annotations:\n    nginx.ingress.kubernetes.io/rewrite-target: /\n  namespace: ing-internal            #\u8c03\u6574\nspec:\n  ingressClassName: nginx            #\u8c03\u6574\n  rules:\n  - http:\n      paths:\n      - path: /hello                 #\u8c03\u6574\n        pathType: Prefix\n        backend:\n          service:\n            name: hello               #\u8c03\u6574\n            port:\n              number: 5678            #\u8c03\u6574\n#\u53c2\u8003\u94fe\u63a5 https://kubernetes.io/docs/concepts/services-networking/ingress/              \n              \nkubectl  apply -f ingress-class.yaml\nkubectl  apply -f ingress.yaml\n')),(0,o.kt)("p",null,"\u9a8c\u8bc1"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"root@node01:~# kubectl  get ingress -n ing-internal\nNAME   CLASS   HOSTS   ADDRESS          PORTS   AGE\nping   nginx   *       10.105.186.107   80      4m7s\nroot@node01:~# curl  10.105.186.107/hello\n")),(0,o.kt)("h2",{id:"6\u6269\u5bb9deployment\u526f\u672c\u6570\u91cf"},"6\u3001\u6269\u5bb9deployment\u526f\u672c\u6570\u91cf"),(0,o.kt)("p",null,"\u8003\u9898:"),(0,o.kt)("p",null,"Task\n\u5c06 deployment presentation \u6269\u5c55\u81f3 4 \u4e2a pods"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"root@node01:~# kubectl  get deploy  -A  | grep  presentation\ndefault            presentation              1/1     1            1           99d\nroot@node01:~# kubectl  scale deploy presentation  --replicas=4\ndeployment.apps/presentation scaled\nroot@node01:~# kubectl  get deploy -A | grep presentation \ndefault            presentation              4/4     4            4           99d\n")),(0,o.kt)("h2",{id:"7\u8c03\u5ea6pod\u5230\u6307\u5b9a\u8282\u70b9"},"7\u3001\u8c03\u5ea6pod\u5230\u6307\u5b9a\u8282\u70b9"),(0,o.kt)("p",null,"Task\n\u6309\u5982\u4e0b\u8981\u6c42\u8c03\u5ea6\u4e00\u4e2a pod\uff1a"),(0,o.kt)("p",null,"\u540d\u79f0\uff1anginx-kusc00401\nImage\uff1anginx\nNode selector\uff1adisk=ssd"),(0,o.kt)("p",null,"\u8003\u70b9\uff1anodeSelect \u5c5e\u6027\u7684\u4f7f\u7528"),(0,o.kt)("p",null,"\u53c2\u8003\u5b98\u7f51\u6587\u6863\uff1a "),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/"},"https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"root@node01:~# kubectl  run nginx-kusc00401  --image=nginx --dry-run=client -o yaml > pod.yaml\n\nroot@node01:~# cat pod.yaml \napiVersion: v1\nkind: Pod\nmetadata:\n  creationTimestamp: null\n  labels:\n    run: nginx-kusc00401\n  name: nginx-kusc00401\nspec:\n  containers:\n  - image: nginx\n    name: nginx-kusc00401\n    resources: {}\n  nodeSelector:   #\u6dfb\u52a0\u6b64\u5904\n    disk: ssd     #\u6dfb\u52a0\u6b64\u5904\n  dnsPolicy: ClusterFirst  \n  restartPolicy: Always    \nstatus: {}\nroot@node01:~# \n\n\u9a8c\u8bc1\uff1a\nroot@node01:~# kubectl  get pods -A -o wide | grep  nginx-kusc00401\ndefault            nginx-kusc00401                            1/1     Running   0               42s   10.244.196.163   node01     <none>           <none>\n")),(0,o.kt)("h2",{id:"8\u67e5\u770b\u53ef\u7528\u8282\u70b9\u6570\u91cf"},"8\u3001\u67e5\u770b\u53ef\u7528\u8282\u70b9\u6570\u91cf"),(0,o.kt)("p",null,"Task\n\u68c0\u67e5\u6709\u591a\u5c11 nodes \u5df2\u51c6\u5907\u5c31\u7eea\uff08\u4e0d\u5305\u62ec\u88ab\u6253\u4e0a Taint\uff1aNoSchedule \u7684\u8282\u70b9\uff09\uff0c\n\u5e76\u5c06\u6570\u91cf\u5199\u5165 /opt/KUSC00402/kusc00402.txt"),(0,o.kt)("p",null,"\u56e0\u4e3a\u9898\u76ee\u8981\u6c42\uff0c\u4e0d\u5305\u62ec\u88ab\u6253\u4e0a Taint\uff1aNoSchedule \u7684\u5c31\u7eea\u8282\u70b9\uff0c\u6240\u4ee5\u8981\u6392\u9664 NoSchedule \u7684"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'root@node01:~# kubectl  describe nodes | grep -i Taints\nTaints:             node-role.kubernetes.io/control-plane:NoSchedule\nTaints:             <none>\nTaints:             <none>\n\nroot@node01:~# echo "2" > /opt/KUSC00402/kusc00402.txt\n\n')),(0,o.kt)("h2",{id:"9\u521b\u5efa\u591a\u5bb9\u5668\u7684-pod"},"9\u3001\u521b\u5efa\u591a\u5bb9\u5668\u7684 pod"),(0,o.kt)("p",null,"[candidate@node-1]"," $ kubectl config use-context k8s Task "),(0,o.kt)("p",null,"\u6309\u5982\u4e0b\u8981\u6c42\u8c03\u5ea6\u4e00\u4e2a Pod\uff1a "),(0,o.kt)("p",null,"\u540d\u79f0\uff1akucc8 app "),(0,o.kt)("p",null,"containers: 2 "),(0,o.kt)("p",null,"container \u540d\u79f0/images\uff1a"),(0,o.kt)("p",null," \u26ab nginx "),(0,o.kt)("p",null,"\u26ab consul"),(0,o.kt)("p",null,"\u8003\u70b9\uff1a \u6982\u5ff5"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/workloads/pods/"},"https://kubernetes.io/docs/concepts/workloads/pods/")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"root@node01:~# cat work-pod.yaml \napiVersion: v1\nkind: Pod \nmetadata:\n  name: kucc8\nspec:\n  containers:\n  - name: nginx\n    image: nginx:1.14.2\n    imagePullPolicy: IfNotPresent\n  - name: consul\n    image: consul\n    imagePullPolicy: IfNotPresent\n\nroot@node01:~# kubectl  get pods  kucc8 \nNAME    READY   STATUS    RESTARTS   AGE\nkucc8   2/2     Running   0          13s\n")),(0,o.kt)("h2",{id:"10\u521b\u5efa-pv"},"10\u3001\u521b\u5efa PV"),(0,o.kt)("p",null,"\u8bbe\u7f6e\u914d\u7f6e\u73af\u5883\uff1a\n","[candidate@node-1]"," $ kubectl config use-context hk8s\nTask\n\u521b\u5efa\u540d\u4e3a app-config \u7684 persistent volume\uff0c\u5bb9\u91cf\u4e3a 1Gi\uff0c\u8bbf\u95ee\u6a21\u5f0f\u4e3a ReadWriteMany\u3002\nvolume \u7c7b\u578b\u4e3a hostPath\uff0c\u4f4d\u4e8e /srv/app-config"),(0,o.kt)("p",null,"\u8003\u70b9\uff1ahostPath \u7c7b\u578b\u7684 pv"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/"},"https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'root@node01:~# cat pv.yaml  \napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: app-config\n  #labels:\n  #  type: local\nspec:\n  #storageClassName: manual\n  capacity:\n    storage: 1Gi\n  accessModes:\n    - ReadWriteMany\n  hostPath:\n    path: "/srv/app-config"\n')),(0,o.kt)("h2",{id:"11\u521b\u5efa-pvc"},"11\u3001\u521b\u5efa PVC"),(0,o.kt)("p",null," \u8003\u9898"),(0,o.kt)("p",null,"Task\n\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 PersistentVolumeClaim\uff1a\n\u540d\u79f0: pv-volume\nClass: csi-hostpath-sc\n\u5bb9\u91cf: 10Mi"),(0,o.kt)("p",null,"\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Pod\uff0c\u6765\u5c06 PersistentVolumeClaim \u4f5c\u4e3a volume \u8fdb\u884c\u6302\u8f7d\uff1a\n\u540d\u79f0\uff1aweb-server\nImage\uff1anginx:1.16\n\u6302\u8f7d\u8def\u5f84\uff1a/usr/share/nginx/html"),(0,o.kt)("p",null,"\u914d\u7f6e\u65b0\u7684 Pod\uff0c\u4ee5\u5bf9 volume \u5177\u6709 ReadWriteOnce \u6743\u9650"),(0,o.kt)("p",null,"\u6700\u540e\uff0c\u4f7f\u7528 kubectl edit \u6216 kubectl patch \u5c06 PersistentVolumeClaim \u7684\u5bb9\u91cf\u6269\u5c55\u4e3a 70Mi\uff0c\u5e76\u8bb0\u5f55\u6b64\u66f4\u6539\u3002"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/#create-a-persistentvolumeclaim"},"https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/#create-a-persistentvolumeclaim")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'#\u521b\u5efapvc\ncandidate@node01:~$ cat pvc.yaml \napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: pv-volume\nspec:\n  storageClassName: csi-hostpath-sc\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 10Mi\n\n\ncandidate@node01:~$ cat pvc-pod.yaml \napiVersion: v1\nkind: Pod\nmetadata:\n  name: web-server\nspec:\n  volumes:\n    - name: task-pv-storage\n      persistentVolumeClaim:\n        claimName: pv-volume  #\u4f7f\u7528\u4e0a\u9762\u521b\u5efa\u7684pvc\u540d\u5b57\n  containers:\n    - name: task-pv-container\n      image: nginx:1.16\n      #ports:\n      #  - containerPort: 80\n      #    name: "http-server"\n      volumeMounts:\n        - mountPath: "/usr/share/nginx/html"\n          name: task-pv-storage\n')),(0,o.kt)("p",null,"\u4fee\u6539\u4e3a70Mi "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl  edit pvc pv-volume --record\n\n\n")),(0,o.kt)("p",null,"\u6ce8\u610f\uff0c\u6a21\u62df\u73af\u5883\u662fnfs,\u4fee\u6539\u5b8c\u540e\u4f1a\u62a5\u9519\u3002 \u8003\u8bd5\u73af\u5883\u6ca1\u6709\u62a5\u9519"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"image-20230829211832745",src:t(25339).Z,width:"930",height:"551"})),(0,o.kt)("h2",{id:"12\u67e5\u770b-pod-\u65e5\u5fd7"},"12\u3001\u67e5\u770b pod \u65e5\u5fd7"),(0,o.kt)("p",null,"Task\n\u76d1\u63a7 pod foo \u7684\u65e5\u5fd7\u5e76\uff1a\n\u63d0\u53d6\u4e0e\u9519\u8bef RLIMIT_NOFILE\n\u76f8\u5bf9\u5e94\u7684\u65e5\u5fd7\u884c \u5c06\u8fd9\u4e9b\u65e5\u5fd7\u884c\u5199\u5165 /opt/KUTR00101/foo"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'candidate@node01:~$ kubectl  logs  foo | grep "RLIMIT_NOFILE" > /opt/KUTR00101/foo\n')),(0,o.kt)("h2",{id:"13\u4f7f\u7528-sidecar-\u4ee3\u7406\u5bb9\u5668\u65e5\u5fd7"},"13\u3001\u4f7f\u7528 sidecar \u4ee3\u7406\u5bb9\u5668\u65e5\u5fd7"),(0,o.kt)("p",null,"\u5b9e\u9645\u4ed8\u6b3e\u4e3a162113.84 \uff0c\u53d1\u7968\u7a0e\u7387\u4e3a13%\uff0c\u5b9e\u9645\u4e3a8%, \u8ba1\u7b97\u5b9e\u9645\u53d1\u7968\u91d1\u989d\u4e3a\u591a\u5c11   "),(0,o.kt)("p",null,"Context\n\u5c06\u4e00\u4e2a\u73b0\u6709\u7684 Pod \u96c6\u6210\u5230 Kubernetes \u7684\u5185\u7f6e\u65e5\u5fd7\u8bb0\u5f55\u4f53\u7cfb\u7ed3\u6784\u4e2d\uff08\u4f8b\u5982 kubectl logs\uff09\u3002\n\u6dfb\u52a0 streaming sidecar \u5bb9\u5668\u662f\u5b9e\u73b0\u6b64\u8981\u6c42\u7684\u4e00\u79cd\u597d\u65b9\u6cd5\u3002"),(0,o.kt)("p",null,"Task\n\u4f7f\u7528 busybox Image \u6765\u5c06\u540d\u4e3a sidecar \u7684 sidecar \u5bb9\u5668\u6dfb\u52a0\u5230\u73b0\u6709\u7684 Pod 11-factor-app \u4e2d\u3002\n\u65b0\u7684 sidecar \u5bb9\u5668\u5fc5\u987b\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n/bin/sh -c tail -n+1 -f /var/log/11-factor-app.log \u4f7f\u7528\u6302\u8f7d\u5728/var/log \u7684 Volume\uff0c\n\u4f7f\u65e5\u5fd7\u6587\u4ef6 11-factor-app.log \u53ef\u7528\u4e8e sidecar \u5bb9\u5668\u3002 \u9664\u4e86\u6dfb\u52a0\u6240\u9700\u8981\u7684 volume mount \u4ee5\u5916\uff0c\u8bf7\u52ff\u66f4\u6539\u73b0\u6709\u5bb9\u5668\u7684\u89c4\u683c\u3002"),(0,o.kt)("p",null,"\u8003\u9898\u7ffb\u8bd1\u6210\u767d\u8bdd\uff0c\u5c31\u662f\uff1a \u6dfb\u52a0\u4e00\u4e2a\u540d\u4e3a sidecar \u7684\u8fb9\u8f66\u5bb9\u5668(\u4f7f\u7528 busybox \u955c\u50cf)\uff0c\u52a0\u5230\u5df2\u6709\u7684 pod 11-factor-app \u4e2d\u3002 \u786e\u4fdd sidecar \u5bb9\u5668\u80fd\u591f\u8f93\u51fa /var/log/11-factor-app.log \u7684\u4fe1\u606f\u3002 \u4f7f\u7528 volume \u6302\u8f7d /var/log \u76ee\u5f55\uff0c\u786e\u4fdd sidecar \u80fd\u8bbf\u95ee 11-factor-app.log \u6587\u4ef6"),(0,o.kt)("p",null,"\u5b98\u65b9\u94fe\u63a5\uff1a "),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/cluster-administration/logging/"},"https://kubernetes.io/docs/concepts/cluster-administration/logging/")),(0,o.kt)("p",null,"\u5177\u4f53\u64cd\u4f5c\u5982\u4e0b"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'#\u4ece\u8003\u8bd5\u673a\u5668\u5bfc\u51fayaml\u914d\u7f6e\u6587\u4ef6\nkubectl  get pods  11-factor-app -o yaml  > varlogs.yaml\n#\u7136\u540e\u5220\u9664pod\ncandidate@node01:~$ kubectl  delete pods 11-factor-app\n\n#\u7136\u540e\u8fdb\u884c\u7f16\u8f91\n\ncandidate@node01:~$ cat varlogs.yaml \napiVersion: v1\nkind: Pod\nmetadata:\n  annotations:\n  creationTimestamp: "2023-05-20T14:22:47Z"\n  name: 11-factor-app\n  namespace: default\nspec:\n  containers:\n  - args:\n    - /bin/sh\n    - -c\n    - |\n      i=0; while true; do\n        echo "$(date) INFO $i" >> /var/log/11-factor-app.log;\n        i=$((i+1));\n        sleep 1;\n      done\n    image: busybox\n    imagePullPolicy: IfNotPresent\n    name: count\n    resources: {}\n    terminationMessagePath: /dev/termination-log\n    terminationMessagePolicy: File\n    volumeMounts:\n    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount\n      name: kube-api-access-rlkbh\n      readOnly: true\n     #\u6dfb\u52a0\u90e8\u5206  \n    - name: varlog\n      mountPath: /var/log\n    #\u6dfb\u52a0\u90e8\u5206  \n  - name: sidecar\n    image: busybox\n    imagePullPolicy: IfNotPresent\n    args: [/bin/sh, -c, \'tail -n+1 -f /var/log/11-factor-app.log\'] \n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n\n  dnsPolicy: ClusterFirst\n  enableServiceLinks: true\n  nodeName: node01\n  nodeSelector:\n    kubernetes.io/hostname: node01\n  preemptionPolicy: PreemptLowerPriority\n  priority: 0\n  restartPolicy: Always\n  schedulerName: default-scheduler\n  securityContext: {}\n  serviceAccount: default\n  serviceAccountName: default\n  terminationGracePeriodSeconds: 30\n  tolerations:\n  - effect: NoExecute\n    key: node.kubernetes.io/not-ready\n    operator: Exists\n    tolerationSeconds: 300\n  - effect: NoExecute\n    key: node.kubernetes.io/unreachable\n    operator: Exists\n    tolerationSeconds: 300\n  volumes:\n  - name: kube-api-access-rlkbh\n    projected:\n      defaultMode: 420\n      sources:\n      - serviceAccountToken:\n          expirationSeconds: 3607\n          path: token\n      - configMap:\n          items:\n          - key: ca.crt\n            path: ca.crt\n          name: kube-root-ca.crt\n      - downwardAPI:\n          items:\n          - fieldRef:\n              apiVersion: v1\n              fieldPath: metadata.namespace\n            path: namespace\n     #\u6dfb\u52a0\u90e8\u5206        \n  - name: varlog\n    emptyDir: {}    \n\ncandidate@node01:~$ kubectl apply -f varlogs.yaml\n\n#\u9a8c\u8bc1\ncandidate@node01:~$ kubectl  logs -f --tail=100 11-factor-app -c sidecar\n')),(0,o.kt)("p",null,"\u6e05\u5355\u6587\u4ef6\u914d\u7f6e\u53c2\u8003"),(0,o.kt)("p",null,"\u4fee\u65391"),(0,o.kt)("img",{src:"images/image-20230830000826070.png",alt:"image-20230830000826070"}),(0,o.kt)("p",null,"\u4fee\u65392"),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"http://minio.zlqit.com:80/file/202311052037258.png",alt:"image-20230830000736618"})),(0,o.kt)("h2",{id:"14\u5347\u7ea7\u96c6\u7fa4"},"14\u3001\u5347\u7ea7\u96c6\u7fa4"),(0,o.kt)("p",null,"Task\n\u73b0\u6709\u7684 Kubernetes \u96c6\u7fa4\u6b63\u5728\u8fd0\u884c\u7248\u672c 1.27.0\u3002\u4ec5\u5c06 master \u8282\u70b9\u4e0a\u7684\u6240\u6709 Kubernetes \u63a7\u5236\u5e73\u9762\u548c\u8282\u70b9\u7ec4\u4ef6\u5347\u7ea7\u5230\u7248\u672c 1.27.1\u3002"),(0,o.kt)("p",null,"\u786e\u4fdd\u5728\u5347\u7ea7\u4e4b\u524d drain master \u8282\u70b9\uff0c\u5e76\u5728\u5347\u7ea7\u540e uncordon master \u8282\u70b9\u3002"),(0,o.kt)("p",null,"\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff0c\u901a\u8fc7 ssh \u8fde\u63a5\u5230 master \u8282\u70b9\uff1a\nssh master01"),(0,o.kt)("p",null,"\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5728\u8be5 master \u8282\u70b9\u4e0a\u83b7\u53d6\u66f4\u9ad8\u6743\u9650\uff1a"),(0,o.kt)("p",null,"sudo -i\n\u53e6\u5916\uff0c\u5728\u4e3b\u8282\u70b9\u4e0a\u5347\u7ea7 kubelet \u548c kubectl\u3002"),(0,o.kt)("p",null,"\u8bf7\u4e0d\u8981\u5347\u7ea7\u5de5\u4f5c\u8282\u70b9\uff0cetcd\uff0ccontainer \u7ba1\u7406\u5668,CNI \u63d2\u4ef6\uff0c DNS \u670d\u52a1\u6216\u4efb\u4f55\u5176\u4ed6\u63d2\u4ef6"),(0,o.kt)("p",null,"\uff08\u6ce8\u610f\uff0c\u8003\u8bd5\u6572\u547d\u4ee4\u65f6\uff0c\u6ce8\u610f\u8981\u5347\u7ea7\u7684\u7248\u672c\uff0c\u6839\u636e\u9898\u76ee\u8981\u6c42\u8f93\u5165\u5177\u4f53\u7684\u5347\u7ea7\u7248\u672c\uff01\uff01\uff01\uff09"),(0,o.kt)("p",null,"\u8003\u70b9\uff1a\u5982\u4f55\u79bb\u7ebf\u4e3b\u673a\uff0c\u5e76\u5347\u7ea7\u63a7\u5236\u9762\u677f\u548c\u5347\u7ea7\u8282\u70b9"),(0,o.kt)("p",null,"\u89e3\u7b54 "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"# kubectl config use-context mk8s\n\n# cordon \u505c\u6b62\u8c03\u5ea6\uff0c\u5c06 node \u8c03\u4e3a SchedulingDisabled\u3002\u65b0 pod \u4e0d\u4f1a\u88ab\u8c03\u5ea6\u5230\u8be5 node\uff0c\u4f46\u5728\u8be5 node \u7684\u65e7 pod \u4e0d\u53d7\u5f71\u54cd\u3002\n# drain \u9a71\u9010\u8282\u70b9\u3002\u9996\u5148\uff0c\u9a71\u9010\u8be5 node \u4e0a\u7684 pod\uff0c\u5e76\u5728\u5176\u4ed6\u8282\u70b9\u91cd\u65b0\u521b\u5efa\u3002\u63a5\u7740\uff0c\u5c06\u8282\u70b9\u8c03\u4e3a SchedulingDisabled\u3002\n# \u6240\u4ee5 kubectl cordon master01 \u8fd9\u6761\uff0c\u53ef\u5199\u53ef\u4e0d\u5199\u3002\u4f46\u6211\u4e00\u5411\u505a\u4e8b\u4e25\u8c28\uff0c\u80fd\u590d\u6742\uff0c\u5c31\u7edd\u4e0d\u7b80\u5355\u4e86\u4e8b\u3002\u3002\u3002\u6240\u4ee5\u5c31\u5199\u4e86\n\ncandidate@node01:~$ kubectl  cordon master01 \nnode/master01 cordoned\ncandidate@node01:~$ kubectl  get nodes \nNAME       STATUS                     ROLES           AGE    VERSION\nmaster01   Ready,SchedulingDisabled   control-plane   101d   v1.27.0\nnode01     Ready                      <none>          101d   v1.27.0\nnode02     Ready                      <none>          101d   v1.27.0\n\n\ncandidate@node01:~$ kubectl  drain  master01 --ignore-daemonsets\n\ncandidate@node01:~$ ssh master01\ncandidate@master01:~$ sudo -i \n\nroot@master01:~# apt-get update\nroot@master01:~# apt-cache show kubeadm | grep 1.27.1\nVersion: 1.27.1-00\nFilename: pool/kubeadm_1.27.1-00_amd64_f18413bf4855208e88cec0d5ac6d4dca03242658bba61a293efbc9eb2b3c5ae6.deb\nFilename: pool/kubeadm_1.25.5-00_amd64_2788155857bba8c7d3529df26085e4a174faec14171d2361dd49fe1e272198fc.deb\nSHA256: 2788155857bba8c7d3529df26085e4a174faec14171d2361dd49fe1e272198fc\nFilename: pool/kubeadm_1.12.8-00_amd64_be31c04079363054e2e112a38a87074b8468edac182781d1d5d9477149131ecb.deb\nSHA256: be31c04079363054e2e112a38a87074b8468edac182781d1d5d9477149131ecb\nroot@master01:~# apt-get install kubeadm=1.27.1-00\n\n\u622a\u56fe\u662f 1.27.0 \u5347\u7ea7 1.27.1 \u7684\n")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"image-20230830002214127",src:t(14870).Z,width:"1916",height:"1040"})),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'root@master01:~# kubeadm version\nkubeadm version: &version.Info{Major:"1", Minor:"27", GitVersion:"v1.27.1", GitCommit:"4c9411232e10168d7b050c49a1b59f6df9d7ea4b", GitTreeState:"clean", BuildDate:"2023-04-14T13:20:04Z", GoVersion:"go1.20.3", Compiler:"gc", Platform:"linux/amd64"}\n\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"# \u9a8c\u8bc1\u5347\u7ea7\u8ba1\u5212\uff0c\u4f1a\u663e\u793a\u5f88\u591a\u53ef\u5347\u7ea7\u7684\u7248\u672c\uff0c\u6211\u4eec\u5173\u6ce8\u9898\u76ee\u8981\u6c42\u5347\u7ea7\u5230\u7684\u90a3\u4e2a\u7248\u672c\u3002\nroot@master01:~# kubeadm upgrade plan\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"# \u6392\u9664 etcd\uff0c\u5347\u7ea7\u5176\u4ed6\u7684\uff0c\u63d0\u793a\u65f6\uff0c\u8f93\u5165 y\u3002\u5927\u7ea6\u8981\u7b49 5 \u5206\u949f\u3002\nkubeadm upgrade apply v1.27.1 --etcd-upgrade=false\n")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"image-20230830002710141",src:t(6105).Z,width:"1144",height:"283"})),(0,o.kt)("p",null,"\u5347\u7ea7 kubelet"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"root@master01:~# apt-get install kubelet=1.27.1-00\nroot@master01:~# kubelet  --version \nKubernetes v1.27.1\n")),(0,o.kt)("p",null,"\u5347\u7ea7 kubectl"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'root@master01:~# apt-get  install kubectl=1.27.1-00\nroot@master01:~# kubectl  version \nWARNING: This version information is deprecated and will be replaced with the output from kubectl version --short.  Use --output=yaml|json to get the full version.\nClient Version: version.Info{Major:"1", Minor:"27", GitVersion:"v1.27.1", GitCommit:"4c9411232e10168d7b050c49a1b59f6df9d7ea4b", GitTreeState:"clean", BuildDate:"2023-04-14T13:21:19Z", GoVersion:"go1.20.3", Compiler:"gc", Platform:"linux/amd64"}\nKustomize Version: v5.0.1\nServer Version: version.Info{Major:"1", Minor:"27", GitVersion:"v1.27.1", GitCommit:"4c9411232e10168d7b050c49a1b59f6df9d7ea4b", GitTreeState:"clean", BuildDate:"2023-04-14T13:14:42Z", GoVersion:"go1.20.3", Compiler:"gc", Platform:"linux/amd64"}\n\n')),(0,o.kt)("p",null,"\u56de\u9000\u8003\u8bd5\u7684\u521d\u59cb\u8282\u70b9candidate@node01"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"root@master01:~# exit \nlogout\ncandidate@master01:~$ exit \nlogout\nConnection to master01 closed.\ncandidate@node01:~$\n")),(0,o.kt)("p",null,"\u6062\u590dmaster01\u8c03\u5ea6"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"candidate@node01:~$ kubectl  uncordon master01 \nnode/master01 uncordoned\n#\u68c0\u67e5 master01 \u662f\u5426\u4e3a Ready\ncandidate@node01:~$ kubectl  get node \nNAME       STATUS   ROLES           AGE    VERSION\nmaster01   Ready    control-plane   101d   v1.27.1\nnode01     Ready    <none>          101d   v1.27.0\nnode02     Ready    <none>          101d   v1.27.0\n")),(0,o.kt)("h2",{id:"15\u5907\u4efd\u8fd8\u539f-etcd"},"15\u3001\u5907\u4efd\u8fd8\u539f etcd"),(0,o.kt)("p",null,"\u8bbe\u7f6e\u914d\u7f6e\u73af\u5883\n\u6b64\u9879\u76ee\u65e0\u9700\u66f4\u6539\u914d\u7f6e\u73af\u5883\u3002\u4f46\u662f\uff0c\u5728\u6267\u884c\u6b64\u9879\u76ee\u4e4b\u524d\uff0c\u8bf7\u786e\u4fdd\u60a8\u5df2\u8fd4\u56de\u521d\u59cb\u8282\u70b9\u3002"),(0,o.kt)("p",null,"[candidate@master01]"," $ exit #\u6ce8\u610f\uff0c\u8fd9\u4e2a\u4e4b\u524d\u662f\u5728 master01 \u4e0a\uff0c\u6240\u4ee5\u8981 exit \u9000\u5230 node01\uff0c\u5982\u679c\u5df2\u7ecf\u662f node01 \u4e86\uff0c\u5c31\u4e0d\u8981\u518d exit \u4e86\u3002"),(0,o.kt)("p",null,"Task\n\u9996\u5148\uff0c\u4e3a\u8fd0\u884c\u5728 ",(0,o.kt)("a",{parentName:"p",href:"https://11.0.1.111:2379"},"https://11.0.1.111:2379"),"  \u4e0a\u7684\u73b0\u6709 etcd \u5b9e\u4f8b\u521b\u5efa\u5feb\u7167\u5e76\u5c06\u5feb\u7167\u4fdd\u5b58\u5230 /var/lib/backup/etcd-snapshot.db"),(0,o.kt)("p",null,"\uff08\u6ce8\u610f\uff0c\u771f\u5b9e\u8003\u8bd5\u4e2d\uff0c\u8fd9\u91cc\u5199\u7684\u662f ",(0,o.kt)("a",{parentName:"p",href:"https://127.0.0.1:2379%EF%BC%89"},"https://127.0.0.1:2379\uff09")),(0,o.kt)("p",null,"\u4e3a\u7ed9\u5b9a\u5b9e\u4f8b\u521b\u5efa\u5feb\u7167\u9884\u8ba1\u80fd\u5728\u51e0\u79d2\u949f\u5185\u5b8c\u6210\u3002 \u5982\u679c\u8be5\u64cd\u4f5c\u4f3c\u4e4e\u6302\u8d77\uff0c\u5219\u547d\u4ee4\u53ef\u80fd\u6709\u95ee\u9898\u3002\u7528 CTRL + C \u6765\u53d6\u6d88\u64cd\u4f5c\uff0c\u7136\u540e\u91cd\u8bd5\u3002\n\u7136\u540e\u8fd8\u539f\u4f4d\u4e8e/data/backup/etcd-snapshot-previous.db \u7684\u73b0\u6709\u5148\u524d\u5feb\u7167\u3002\n\u63d0\u4f9b\u4e86\u4ee5\u4e0b TLS \u8bc1\u4e66\u548c\u5bc6\u94a5\uff0c\u4ee5\u901a\u8fc7 etcdctl \u8fde\u63a5\u5230\u670d\u52a1\u5668\u3002"),(0,o.kt)("p",null,"CA \u8bc1\u4e66: /opt/KUIN00601/ca.crt\n\u5ba2\u6237\u7aef\u8bc1\u4e66: /opt/KUIN00601/etcd-client.crt\n\u5ba2\u6237\u7aef\u5bc6\u94a5: /opt/KUIN00601/etcd-client.key"),(0,o.kt)("p",null,"\u8003\u70b9\uff1aetcd \u7684\u5907\u4efd\u548c\u8fd8\u539f\u547d\u4ee4"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'candidate@node01:~$ export ETCDCTL_API=3\ncandidate@node01:~$ etcdctl  --endpoints=https://11.0.1.111:2379 --cacert="/opt/KUIN00601/ca.crt" --cert="/opt/KUIN00601/etcd-client.crt" --key="/opt/KUIN00601/etcd-client.key"  snapshot save /var/lib/backup/etcd-snapshot.db \n{"level":"info","ts":"2023-08-31T01:32:18.023+0800","caller":"snapshot/v3_snapshot.go:65","msg":"created temporary db file","path":"/var/lib/backup/etcd-snapshot.db.part"}\n{"level":"info","ts":"2023-08-31T01:32:18.032+0800","logger":"client","caller":"v3@v3.5.7/maintenance.go:212","msg":"opened snapshot stream; downloading"}\n{"level":"info","ts":"2023-08-31T01:32:18.032+0800","caller":"snapshot/v3_snapshot.go:73","msg":"fetching snapshot","endpoint":"https://11.0.1.111:2379"}\n{"level":"info","ts":"2023-08-31T01:32:18.183+0800","logger":"client","caller":"v3@v3.5.7/maintenance.go:220","msg":"completed snapshot read; closing"}\n{"level":"info","ts":"2023-08-31T01:32:18.192+0800","caller":"snapshot/v3_snapshot.go:88","msg":"fetched snapshot","endpoint":"https://11.0.1.111:2379","size":"9.8 MB","took":"now"}\n{"level":"info","ts":"2023-08-31T01:32:18.192+0800","caller":"snapshot/v3_snapshot.go:97","msg":"saved","path":"/var/lib/backup/etcd-snapshot.db"}\nSnapshot saved at /var/lib/backup/etcd-snapshot.db\ncandidate@node01:~$ ls -l /var/lib/backup/etcd-snapshot.db \n-rw-------+ 1 candidate candidate 9846816 Aug 31 01:32 /var/lib/backup/etcd-snapshot.db\n')),(0,o.kt)("p",null,"\u68c0\u67e5\uff1a\uff08\u8003\u8bd5\u65f6\uff0c\u8fd9\u4e9b\u68c0\u67e5\u52a8\u4f5c\uff0c\u90fd\u53ef\u4ee5\u4e0d\u505a\uff09\netcdctl snapshot status /var/lib/backup/etcd-snapshot.db -wtable"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"candidate@node01:~$ etcdctl  snapshot status  /var/lib/backup/etcd-snapshot.db    -wtable \nDeprecated: Use `etcdutl snapshot status` instead.\n\n+----------+----------+------------+------------+\n|   HASH   | REVISION | TOTAL KEYS | TOTAL SIZE |\n+----------+----------+------------+------------+\n| 43bb1477 |   245642 |       1627 |     9.8 MB |\n+----------+----------+------------+------------+\n")),(0,o.kt)("p",null,"\u8fd8\u539f\uff1a\n#\u8003\u8bd5\u65f6\uff0c/data/backup/etcd-snapshot-previous.db \u7684\u6743\u9650\u5e94\u8be5\u662f\u53ea\u6709 root \u53ef\u8bfb\uff0c\u6240\u4ee5\u9700\u8981\u4f7f\u7528 sudo \u547d\u4ee4\u3002\n#\u53ef\u4ee5 ll /data/backup/etcd-snapshot-previous.db \u68c0\u67e5\u4e00\u4e0b\u8bfb\u5199\u6743\u9650\u548c\u5c5e\u4e3b\u3002"),(0,o.kt)("p",null,"#"," \u4e0d\u52a0 sudo \u4f1a\u62a5\u9519 permission denied\uff0c \u4e0a\u9762\u6267\u884c\u4e86 export ETCDCTL_API=3 \u4e86\uff0c\u4e0b\u9762\u5c31\u53ef\u4ee5\u4e0d\u5199 ETCDCTL_API=3d \u7684\uff0c\u53e6\u5916\u8fd8\u539f\u4e5f\u662f\u53ef\u4ee5\u4e0d\u5199\u8bc1\u4e66\u7684\uff08--cacert --cert --key\uff09\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'candidate@node01:~$ sudo  ETCDCTL_API=3 etcdctl  --endpoints=https://11.0.1.111:2379  snapshot restore /data/backup/etcd-snapshot-previous.db \nDeprecated: Use `etcdutl snapshot restore` instead.\n\n2023-08-31T01:37:47+08:00   info    snapshot/v3_snapshot.go:248 restoring snapshot  {"path": "/data/backup/etcd-snapshot-previous.db", "wal-dir": "default.etcd/member/wal", "data-dir": "default.etcd", "snap-dir": "default.etcd/member/snap", "stack": "go.etcd.io/etcd/etcdutl/v3/snapshot.(*v3Manager).Restore\\n\\tgo.etcd.io/etcd/etcdutl/v3@v3.5.7/snapshot/v3_snapshot.go:254\\ngo.etcd.io/etcd/etcdutl/v3/etcdutl.SnapshotRestoreCommandFunc\\n\\tgo.etcd.io/etcd/etcdutl/v3@v3.5.7/etcdutl/snapshot_command.go:147\\ngo.etcd.io/etcd/etcdctl/v3/ctlv3/command.snapshotRestoreCommandFunc\\n\\tgo.etcd.io/etcd/etcdctl/v3/ctlv3/command/snapshot_command.go:129\\ngithub.com/spf13/cobra.(*Command).execute\\n\\tgithub.com/spf13/cobra@v1.1.3/command.go:856\\ngithub.com/spf13/cobra.(*Command).ExecuteC\\n\\tgithub.com/spf13/cobra@v1.1.3/command.go:960\\ngithub.com/spf13/cobra.(*Command).Execute\\n\\tgithub.com/spf13/cobra@v1.1.3/command.go:897\\ngo.etcd.io/etcd/etcdctl/v3/ctlv3.Start\\n\\tgo.etcd.io/etcd/etcdctl/v3/ctlv3/ctl.go:107\\ngo.etcd.io/etcd/etcdctl/v3/ctlv3.MustStart\\n\\tgo.etcd.io/etcd/etcdctl/v3/ctlv3/ctl.go:111\\nmain.main\\n\\tgo.etcd.io/etcd/etcdctl/v3/main.go:59\\nruntime.main\\n\\truntime/proc.go:255"}\n2023-08-31T01:37:47+08:00   info    membership/store.go:141 Trimming membership information from the backend...\n2023-08-31T01:37:47+08:00   info    membership/cluster.go:421   added member    {"cluster-id": "cdf818194e3a8c32", "local-member-id": "0", "added-peer-id": "8e9e05c52164694d", "added-peer-peer-urls": ["http://localhost:2380"]}\n2023-08-31T01:37:47+08:00   info    snapshot/v3_snapshot.go:269 restored snapshot   {"path": "/data/backup/etcd-snapshot-previous.db", "wal-dir": "default.etcd/member/wal", "data-dir": "default.etcd", "snap-dir": "default.etcd/member/snap"}\n\n')),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"\u8003\u8bd5\u65f6\uff0cetcd \u662f\u5728 node01 \u4e0a\u8fd0\u884c\u7684\uff0c\u6240\u4ee5\u8003\u8bd5\u65f6\uff0c\u8003\u9898\u91cc\u7684\u7f51\u5740\u5199\u7684\u662f ",(0,o.kt)("a",{parentName:"p",href:"https://127.0.0.1:2379%E3%80%82"},"https://127.0.0.1:2379\u3002")),(0,o.kt)("p",{parentName:"blockquote"},"\u4f46\u662f\u6a21\u62df\u73af\u5883\u91cc\uff0c\u867d\u7136\u4e5f\u6a21\u62df\u5728 node01 \u4e0a\u9762\u6267\u884c\u6570\u636e\u6062\u590d\uff0c\u4f46 etcd \u5b9e\u9645\u662f\u5728 master01 \u8282\u70b9\uff0c\u6240\u4ee5\u8fd8\u539f\u5b9e\u9645\u6ca1\u6709\u771f\u6b63\u6548\u679c\u7684\u3002 \u4f46\u662f\uff0c\u8003\u8bd5\u65f6\uff0c\u6267\u884c\u4e0a\u9762\u7684\u547d\u4ee4\uff0c\u662f\u6ca1\u6709\u95ee\u9898\u7684\u3002")),(0,o.kt)("p",null,"\u751f\u4ea7\u573a\u666f\u4e0b\uff0c\u771f\u6b63\u6062\u590d\u7684\u65f6\u5019 \u662f\u5fc5\u987b\u8981\u5148\u5c06 etcd data \u76ee\u5f55\u6e05\u7406\u6389\u6216\u8005\u79fb\u8d70\uff0c\u7136\u540e\u518d\u53bb\u6267\u884c snapshot restore\uff0c\u8fd9\u65f6\u96c6\u7fa4\u7684\u6570\u636e\u5c31\u4e00\u5b9a\u548c snapshot \u5907\u4efd\u4e2d\u7684\u6570\u636e \u7edf\u4e00\u4e86\u3002\u6bd4\u5982\u65b9\u6cd5 3 \u7684\u64cd\u4f5c\u65b9\u6cd5\u3002 \u611f\u8c22\u7f51\u53cb\u5584\u5148\u751f"),(0,o.kt)("h2",{id:"16\u6392\u67e5\u96c6\u7fa4\u4e2d\u6545\u969c\u8282\u70b9"},"16\u3001\u6392\u67e5\u96c6\u7fa4\u4e2d\u6545\u969c\u8282\u70b9"),(0,o.kt)("p",null,"Task"),(0,o.kt)("p",null,"\u540d\u4e3a node02 \u7684 Kubernetes worker node \u5904\u4e8e NotReady \u72b6\u6001\u3002\n\u8c03\u67e5\u53d1\u751f\u8fd9\u79cd\u60c5\u51b5\u7684\u539f\u56e0\uff0c\u5e76\u91c7\u53d6\u76f8\u5e94\u7684\u63aa\u65bd\u5c06 node \u6062\u590d\u4e3a Ready \u72b6\u6001\uff0c\u786e\u4fdd\u6240\u505a\u7684\u4efb\u4f55\u66f4\u6539\u6c38\u4e45\u751f\u6548\u3002"),(0,o.kt)("p",null,"\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff0c\u901a\u8fc7 ssh \u8fde\u63a5\u5230 node02 \u8282\u70b9\uff1a\nssh node02 \u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5728\u8be5\u8282\u70b9\u4e0a\u83b7\u53d6\u66f4\u9ad8\u6743\u9650\uff1a\nsudo -i"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"#\u767b\u5f55node02\u8282\u70b9\uff0c\u7136\u540e\u542f\u52a8kubelet\nsystemctl start kubelet \n")),(0,o.kt)("h2",{id:"17\u8282\u70b9\u7ef4\u62a4"},"17\u3001\u8282\u70b9\u7ef4\u62a4"),(0,o.kt)("p",null,"Task"),(0,o.kt)("p",null,"\u5c06\u540d\u4e3a node02 \u7684 node \u8bbe\u7f6e\u4e3a\u4e0d\u53ef\u7528\uff0c\u5e76\u91cd\u65b0\u8c03\u5ea6\u8be5 node \u4e0a\u6240\u6709\u8fd0\u884c\u7684 pods"),(0,o.kt)("p",null,"\u8003\u70b9\uff1acordon \u548c drain \u547d\u4ee4\u7684\u4f7f\u7528"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"candidate@node01:~$ kubectl  cordon node02 \nnode/node02 cordoned\ncandidate@node01:~$ kubectl  drain node02   --ignore-daemonsets  --delete-emptydir-data  --force \n")),(0,o.kt)("p",null,"\u9a8c\u8bc1:"),(0,o.kt)("p",null,"\u6b63\u5e38\u5df2\u7ecf\u6ca1\u6709 pod \u5728 node02 \u4e0a\u4e86\u3002\u4f46\u6d4b\u8bd5\u73af\u5883\u91cc\u7684 ingress\u3001calico\u3001kube-proxy \u662f daemonsets \u6a21\u5f0f\u7684\uff0c\u6240\u4ee5\u663e\u793a\u8fd8\u5728 node02 \u4e0a\uff0c\u5ffd\u7565\u5373\u53ef\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"candidate@node01:~$ kubectl  get pods -A -o wide | grep node02 \ncalico-system      calico-node-9wv7w                          1/1     Running            5 (28h ago)    102d   11.0.1.113       node02     <none>           <none>\ncalico-system      csi-node-driver-rsr2w                      2/2     Running            10 (28h ago)   102d   10.244.140.96    node02     <none>           <none>\ningress-nginx      ingress-nginx-controller-48m8c             1/1     Running            3 (28h ago)    102d   11.0.1.113       node02     <none>           <none>\nkube-system        kube-proxy-xtm62                           1/1     Running            0              25h    11.0.1.113       node02     <none>           <none>\n\n")))}u.isMDXComponent=!0},21583:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/1-3398cda04e2595e62d8648582c2ab803.jpg"},15410:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/2-6c7df2e1da870892a3d97aa51fd0d660.jpg"},44081:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/3-144f327a9e8b512e80b784716097d438.jpg"},25339:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20230829211832745-e9aac181975dc1cb237eaba19a02983a.png"},14870:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20230830002214127-c3432c4709d2353ddec48c6b46fb5dff.png"},6105:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/image-20230830002710141-4a9c4d5362e6b1f0ad80e831285e101d.png"}}]);